"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,r,t,o){void 0===o&&(o=t);var i=Object.getOwnPropertyDescriptor(r,t);i&&!("get"in i?!r.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return r[t]}}),Object.defineProperty(e,o,i)}:function(e,r,t,o){void 0===o&&(o=t),e[o]=r[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(r,e,t);return __setModuleDefault(r,e),r},__awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,c){function n(e){try{a(o.next(e))}catch(e){c(e)}}function s(e){try{a(o.throw(e))}catch(e){c(e)}}function a(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(n,s)}a((o=o.apply(e,r||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ChromeLauncher=__importStar(require("chrome-launcher")),chrome_remote_interface_1=__importDefault(require("chrome-remote-interface")),fs_1=__importDefault(require("fs")),Error_1=__importStar(require("../../common/Error")),common_error_1=require("../../common/common-error"),compile_error_1=require("../../common/compile-error"),request_error_1=require("../../common/request-error"),unknown_error_1=require("../../common/unknown-error"),api_1=require("../../config/api"),protocol_1=require("../../protocol"),preview_1=require("../../protocol/preview"),commonData_1=require("../../types/commonData"),timer_1=__importDefault(require("../../utils/timer")),Block_1=__importDefault(require("../upload/help/Block")),Upload_1=__importDefault(require("../upload/help/Upload")),live_1=__importDefault(require("./live")),util_1=require("./util");class BlockPreviewModule extends live_1.default{constructor(){super(...arguments),this.previewChromeInstance=null,this.currentCompilePath="",this.currentPreviewBlock=null}registerEvents(e){super.registerEvents(e),e.addEventListener(protocol_1.ModuleName.compile,protocol_1.CompileEventEnum.WatchCompileEnd,e=>{e.errMsg&&e.data&&e.data.appType===commonData_1.AppTypeEnum.Block&&"force"===e.data.from&&this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:e.errMsg})})}getBlockPreviewFormData(e){return Object.assign(Object.assign({extension_id:e.blockTypeID,source:fs_1.default.createReadStream(e.packagePath),compile_type:{search:'["block_h5_zip"]',docs:'["block_pc_splits_main_pkg"]',workplace:'["block_pc_splits_main_pkg","block_mobile_lynx_pkg"]'}[e.host],need_message_card:["workplace","search"].includes(e.host).toString(),host:e.host},e.debug_info?{debug_info:JSON.stringify(e.debug_info)}:{}),{extension_sub_type:e.extensionSubType||"block_dsl"})}getBlockDocsUrl(e){return __awaiter(this,void 0,void 0,(function*(){const r="DEBUG"===process.env.env,t=(0,api_1.getDomain)(e.environment,api_1.API.spaceHome.type)||"feishu.cn";if(!e.url){yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.loginDocs,{app_id:2,query_scope:"all",redirect_uri:`https%3A%2F%2Fwww.${t}%2Fdrive%2Fhome%2F%3Flogin_redirect_times%3D1`});const r=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.createDocs,"parent_token=&type=22&name=云文档小组件的测试文档",{headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:`https://www.${t}/space/home`}});if(!r.url)throw new Error("Failed to create the document, please try to specify the document link through the parameter --docs-url");e.url=r.url}const o=new URL(e.url);if(!o.host.endsWith(t)&&!r)throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:"Docs URL is invalid",advise:`Current environment is ${e.environment}, you need to open the document that matches the environment`});if(!/doc(x|s)/.test(o.pathname)&&!r)throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:"Docs URL is invalid"});return o}))}compileBlock(e,r){return __awaiter(this,void 0,void 0,(function*(){try{this.emitProgress({step:"Uploading"});const t=[];let o=r.blockTypeID;o||(o=yield e.choose());const i=yield e.readBlockConfig(o),c=e.getRelativePath(i),n=e.rewriteProjectConfig(i);let s;try{s=yield Upload_1.default.compress({version:"preview",platform:r.platform,compilePath:r.compilePath,appId:r.appId,globs:[e.projectConfigFileName,c?c+"/**/*":"**/*"],appType:"block"})}catch(e){if(e.code!==Error_1.CoreErrorCode.PARAM_ERROR||!e.advise)throw new common_error_1.CommonError(Error_1.CoreErrorCode.CORE_MODULE_ERROR,2300000002,e.message,e.code,e.stack);s=e.advise,t.push(e.toString())}n();const a=yield Upload_1.default.upload("previewBlock",r.appId,this.getBlockPreviewFormData(Object.assign({host:r.host,packagePath:s,blockTypeID:o,extensionSubType:r.extensionSubType},(0,util_1.getDebugInfo)(this.execute,r.compilePath,"block"))),{traceId:r.traceId},this.execute);Upload_1.default.checkUploadResponds(a),this.emitProgress({step:"Uploading",progress:0,version:"preview",identifier:"block-preview"}),yield Upload_1.default.checkCompileProgress(r.appId,"blockCompileProgress",this.execute,"block","",r.traceId),this.emitProgress({step:"Uploading",done:!0,status:"success",identifier:"block-preview"});const l=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getPreviewToken,{appId:r.appId,previewId:a.data.preview_id});return this.emitProgress({step:"Preview succeed",done:!0,status:"success"}),{previewID:a.data.preview_id,previewToken:l.previewToken,warnMsgs:t}}catch(e){this.emitProgress({step:"Preview failed",done:!0,status:"fail",identifier:"block-preview"});throw this.log.bind(this,"error","compileBlock")("preview","failed",e),e}}))}[preview_1.CmdEnum.previewBlock](e){return __awaiter(this,void 0,void 0,(function*(){const r=this.log.bind(this,"info",preview_1.CmdEnum.previewBlock);r("receiveParams","end",{options:e}),r("prepareCheck","start");const{appId:t,compilePath:o}=yield Upload_1.default.prepareCheck(e.compilePath,e.appId,this.execute);r("prepareCheck","end");const i=this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.Info),c=(0,api_1.getDomain)(i.env)||"feishu.cn";if(this.currentPreviewBlock&&this.currentCompilePath===o||(this.currentCompilePath=o,this.currentPreviewBlock=new Block_1.default({projectPath:o,execute:this.execute,watch:!0})),e.host?this.currentPreviewBlock.checkHost(e.host):e.host=yield this.currentPreviewBlock.chooseHost(),"docs"===e.host){r("previewDocs","start"),timer_1.default.start("block_preview");const n=yield this.getBlockDocsUrl({url:e.docsUrl,domain:c,environment:i.env});let s;if(r("getBlockDocsUrl","end",{url:n}),e.platform||(e.platform="pc"),"pc"===e.platform){r("startHTTPServer","start");s=(yield this.currentPreviewBlock.startHTTPServer("")).toString()}else{r("compileBlock","start");const{previewID:i,previewToken:n,warnMsgs:a}=yield this.compileBlock(this.currentPreviewBlock,{appId:t,compilePath:o,host:e.host,platform:e.platform,blockTypeID:e.blockTypeID});r("compileBlock","end",{previewID:i,previewToken:n,warnMsgs:a}),s=`https://open.${c}${(0,api_1.getBasePath)("devtools")}/app/${t}/block/preview/${i}&previewtoken=${n}`}const a=new URLSearchParams(n.search.slice(1));if(a.set("blockitdebug","true"),a.set("debugport",s),n.search="?"+a.toString(),"pc"===e.platform)if(e.openExternal)this.openExternal(n.href);else{r("launchChrome","start");const e=ChromeLauncher.Launcher.getFirstInstallation();if(!e)throw this.openExternal(n.href),new Error_1.default({code:Error_1.CoreErrorCode.FILE_NOT_FOUND,message:"Chrome not found"});this.previewChromeInstance&&(r("killPreviewChromeInstance","start"),this.previewChromeInstance.kill(),this.previewChromeInstance=null,r("killPreviewChromeInstance","end")),this.previewChromeInstance=yield ChromeLauncher.launch({chromePath:e,startingUrl:"about:blank",chromeFlags:[]}),r("launchChrome","end"),this.previewChromeInstance.process.addListener("exit",()=>{this.previewChromeInstance=null}),process.on("exit",()=>{var e;null===(e=this.previewChromeInstance)||void 0===e||e.kill()}),r("connectCDP","start",{port:this.previewChromeInstance.port}),this.currentPreviewBlock.CDPClient=yield(0,chrome_remote_interface_1.default)({port:this.previewChromeInstance.port}),r("connectCDP","end");const{Network:t,Page:o}=this.currentPreviewBlock.CDPClient;yield t.enable(),yield o.enable(),yield t.setCacheDisabled({cacheDisabled:!0}),yield t.setCookie({name:"session",value:i.larkSession,domain:"."+c,path:"/",secure:!0,httpOnly:!0,sameSite:"None"}),yield o.navigate({url:n.href})}else yield this.displayQRCode(n.href),r("displayQRCode","end",{href:n.href});this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"block_preview",Object.assign(Object.assign({},timer_1.default.end("block_preview")),{host:e.host,isCustome:!!e.docsUrl,url:n})),r("previewDocs","end")}else if("workplace"===e.host){r("previewWorkplace","start"),timer_1.default.start("block_preview");try{r("compileBlock","start"),yield this.compileBlock(this.currentPreviewBlock,{appId:t,compilePath:o,host:e.host,platform:e.platform,blockTypeID:e.blockTypeID}),r("compileBlock","end"),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"block_preview",Object.assign(Object.assign({},timer_1.default.end("block_preview")),{host:e.host})),this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:"Success! You will receive a message card, click to preview."}),r("previewWorkplace","end")}catch(t){throw r("previewWorkplace","end",{error:t}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"block_preview",Object.assign(Object.assign({},timer_1.default.end("block_preview")),{host:e.host,error:t})),(0,request_error_1.isRequestError)(t)||(0,compile_error_1.isCompileError)(t)||(0,common_error_1.isCommonError)(t)?t:new unknown_error_1.UnknownError(t.message,t.stack)}}}))}[preview_1.CmdEnum.previewH5Block](e){return __awaiter(this,void 0,void 0,(function*(){const r=this.log.bind(this,"info",preview_1.CmdEnum.previewH5Block);r("receiveParams","end",{options:e}),r("checkLogin","start"),Upload_1.default.checkLogin(this.execute),r("checkLogin","end"),this.currentPreviewBlock=new Block_1.default({projectPath:e.compilePath,execute:this.execute});const{previewToken:t}=yield this.compileBlock(this.currentPreviewBlock,{host:"search",platform:"pc",compilePath:e.compilePath,appId:e.appId,blockTypeID:e.blockTypeID,extensionSubType:"block_h5"});return{previewToken:t}}))}}exports.default=BlockPreviewModule;