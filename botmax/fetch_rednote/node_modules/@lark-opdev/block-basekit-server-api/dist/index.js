"use strict";var te=Object.create;var b=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ie=(n,e)=>{for(var r in e)b(n,r,{get:e[r],enumerable:!0})},U=(n,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of re(e))!se.call(n,o)&&o!==r&&b(n,o,{get:()=>e[o],enumerable:!(t=ne(e,o))||t.enumerable});return n};var k=(n,e,r)=>(r=n!=null?te(oe(n)):{},U(e||!n||!n.__esModule?b(r,"default",{value:n,enumerable:!0}):r,n)),ae=n=>U(b({},"__esModule",{value:!0}),n);var Pe={};ie(Pe,{AuthorizationType:()=>J,Basekit:()=>P,Component:()=>B,DateFormatter:()=>Q,FieldCode:()=>Z,FieldComponent:()=>G,FieldComponentEnum:()=>q,FieldType:()=>v,NextStep:()=>W,NumberFormatter:()=>K,ParamType:()=>N,StructureType:()=>$,TriggerType:()=>V,base:()=>me,basekit:()=>S,bitable:()=>ue,createActionContext:()=>ke,createFetch:()=>X,createFieldContext:()=>Ae,execute:()=>ye,field:()=>le,generateOptions:()=>be,getBasekitUrl:()=>Ie,newPack:()=>ge,t:()=>xe,testAction:()=>Y,testActionAutocomplete:()=>fe,testField:()=>he,uploadAttachments:()=>Te});module.exports=ae(Pe);var y=k(require("node-fetch")),A=k(require("path")),D=k(require("fs")),M=k(require("form-data")),H=k(require("mime"));var ce={string:n=>typeof n=="string",number:n=>typeof n=="number",object:n=>typeof n=="object"&&n!==null&&!Array.isArray(n),array:n=>Array.isArray(n),boolean:n=>typeof n=="boolean",link:n=>{if(typeof n!="string")throw new Error("result is not a string");if(!/^(?:(?:https?|ftp):\/\/)?[\w/\-?=%.]+\.[\w/\-?=%.]+$/.test(n))throw new Error("result is not a valid link");return!0},timestamp:n=>typeof n!="string"||typeof n!="number"||isNaN(n)?!1:!!/^(\d{10}|\d{13})$/.test(String(n)),null:n=>n===null},pe=new Proxy(ce,{get(n,e){return r=>{if(r===void 0)return!0;let t=Reflect.get(n,e);if(t===void 0)throw new Error(`Unknown property "${String(e)}"`);return t(r)}}});function w(n,e,r=[]){let t=e?.type,o=e&&"properties"in e?e.properties:void 0;r.length===0&&t!=="object"&&console.log("\x1B[31m The type field of the root node of resultType must be object.\x1B[0m");let a={errorDesc:{},propertyMissingDescInResultType:{},propertyMissingInResult:{}},i=Object.keys(n),g=Object.keys(o||{}),c=[],p=r.join(".")||"execute returned value";for(let l=0;l<i.length;l++){let m=i[l];g.includes(m)||c.push(m)}c.length&&(a.propertyMissingDescInResultType[p]=c);let h=[];for(let l=0;l<g.length;l++){let m=g[l];i.includes(m)||h.push(m)}return h.length&&(console.log(`
\x1B[31m Missing property\u300C${h.join(",")}\u300Din\u300C${p}\u300D\x1B[0m`),a.propertyMissingInResult[p]=h),i.forEach(l=>{let m=n[l],u=r.concat(l),f;if(e?.type==="object"&&(f=e.properties[l]),f&&typeof f=="object"){let d=f.type;pe[d](m)||(console.log(`
\x1B[31m The type of\u300C${u.join(".")}\u300Dshould be\u300C${d}\u300D \x1B[0m`),a.errorDesc[u.join(".")]={value:n[l],resultType:d})}if(typeof n[l]=="object"&&n[l]!==null){let d=w(n[l],o?.[l],u);a={errorDesc:{...d.errorDesc,...a.errorDesc},propertyMissingDescInResultType:{...d.propertyMissingDescInResultType,...a.propertyMissingDescInResultType},propertyMissingInResult:{...d.propertyMissingInResult,...a.propertyMissingInResult}}}}),a}var R=k(require("url")),v=(s=>(s[s.NotSupport=0]="NotSupport",s[s.Text=1]="Text",s[s.Number=2]="Number",s[s.SingleSelect=3]="SingleSelect",s[s.MultiSelect=4]="MultiSelect",s[s.DateTime=5]="DateTime",s[s.Checkbox=7]="Checkbox",s[s.User=11]="User",s[s.Phone=13]="Phone",s[s.Url=15]="Url",s[s.Attachment=17]="Attachment",s[s.SingleLink=18]="SingleLink",s[s.Lookup=19]="Lookup",s[s.Formula=20]="Formula",s[s.DuplexLink=21]="DuplexLink",s[s.Location=22]="Location",s[s.GroupChat=23]="GroupChat",s[s.Stage=24]="Stage",s[s.Object=25]="Object",s[s.Denied=403]="Denied",s[s.CreatedTime=1001]="CreatedTime",s[s.ModifiedTime=1002]="ModifiedTime",s[s.CreatedUser=1003]="CreatedUser",s[s.ModifiedUser=1004]="ModifiedUser",s[s.AutoNumber=1005]="AutoNumber",s[s.VirtualTrigger=3001]="VirtualTrigger",s[s.Barcode=99001]="Barcode",s[s.Progress=99002]="Progress",s[s.Currency=99003]="Currency",s[s.Rating=99004]="Rating",s[s.Email=99005]="Email",s))(v||{}),N=(c=>(c.Null="null",c.Number="number",c.String="string",c.Boolean="boolean",c.Link="link",c.Timestamp="timestamp",c.Array="array",c.Object="object",c))(N||{}),B=(u=>(u.Input="TextEditor",u.DateTimePicker="DateTimeInput",u.ContactPicker="UserSelect",u.Collapse="Collapse",u.Checkbox="CheckboxInput",u.Tips="InfoTips",u.TableSelect="TableSelect",u.TableViewSelect="TableViewSelect",u.SingleSelect="SingleSelect",u.MultipleSelect="MultipleSelect",u.Attachment="AttachmentInput",u.Radio="Radio",u.KeyValuePair="KeyValuePair",u))(B||{}),q=(i=>(i.Input="TextEditor",i.SingleSelect="SingleSelect",i.MultipleSelect="MultipleSelect",i.Radio="Radio",i.TableSelect="TableSelect",i.FieldSelect="FieldSelect",i))(q||{}),$=(o=>(o.User="user",o.Group="group",o.Attachment="attachment",o.Options="options",o))($||{}),V=(i=>(i.AddRecord="AddRecordTrigger",i.SetRecord="SetRecordTrigger",i.ChangeRecord="ChangeRecordTrigger",i.Timer="TimerTrigger",i.Reminder="ReminderTrigger",i.Button="ButtonTrigger",i))(V||{}),W=(a=>(a.LarkMessage="LarkMessageAction",a.AddRecord="AddRecordAction",a.SetRecord="SetRecordAction",a.FindRecord="FindRecordAction",a.HTTPClient="HTTPClientAction",a))(W||{}),K=(p=>(p.INTEGER="0",p.DIGITAL_ROUNDED_1="0.0",p.DIGITAL_ROUNDED_2="0.00",p.DIGITAL_ROUNDED_3="0.000",p.DIGITAL_ROUNDED_4="0.0000",p.DIGITAL_THOUSANDS="1,000",p.DIGITAL_THOUSANDS_DECIMALS="1,000.00",p.PERCENTAGE_ROUNDED="0%",p.PERCENTAGE="0.00%",p))(K||{}),Q=(g=>(g.DATE_YMD_WITH_SLASH="yyyy/MM/dd",g.DATE_TIME="yyyy/MM/dd HH:mm",g.DATE_TIME_WITH_HYPHEN="yyyy-MM-dd HH:mm",g.DATE_YMD_WITH_HYPHEN="yyyy-MM-dd",g.DATE_MD_WITH_HYPHEN="MM-dd",g.DATE_MMDD_WITH_SLASH="MM/dd/yyyy",g.DATE_DDMM_WITH_SLASH="dd/MM/yyyy",g))(Q||{}),G=(i=>(i.SingleSelect="SingleSelect",i.Input="Text",i.Radio="Radio",i.FieldSelect="FieldSelect",i.MultipleSelect="MultipleSelect",i.TableSelect="TableSelect",i))(G||{}),Z=(p=>(p[p.Success=0]="Success",p[p.Error=1254500]="Error",p[p.ConfigError=1254400]="ConfigError",p[p.InvalidArgument=1254406]="InvalidArgument",p[p.AuthorizationError=1254403]="AuthorizationError",p[p.PayError=1254505]="PayError",p[p.RateLimit=1254404]="RateLimit",p[p.QuotaExhausted=1254405]="QuotaExhausted",p[p.FeishuPaidBenefitsExhausted=1254506]="FeishuPaidBenefitsExhausted",p))(Z||{}),J=(c=>(c.HeaderBearerToken="HeaderBearerToken",c.Basic="Basic",c.CustomHeaderToken="CustomHeaderToken",c.MultiHeaderToken="MultiHeaderToken",c.QueryParamToken="QueryParamToken",c.MultiQueryParamToken="MultiQueryParamToken",c.Custom="Custom",c.OAuth2="OAuth2",c))(J||{}),P=class{addDomainList(e){this.domainList=e}addAction(e){this.action=e}addField(e){this.field=e}setI18n(e){this.i18n=e}},S=new P,le={t(n){return`\${{${n}}}`}},ue=S,me=S;function ge(){return S}function z(n){let e=process.cwd(),r,t=A.default.join(e,"src/register.ts"),o=A.default.join(e,"src/register.js");if(D.default.existsSync(t))r=t;else if(D.default.existsSync(o))r=o;else if(n==="field")r=A.default.join(e,"src/index.ts");else throw new Error("Can not find src/register.ts file");let a=require(r);return a.default||a}async function Y(n,e){let r=z(),t=r.action?.resultType,o=await r?.action?.execute(n,e);return w(o,t),console.log(o),o}function de(n,e){n.code===0&&e.type===25&&e.extra.properties.forEach(r=>{let{key:t}=r;if(!(typeof n.data=="object"&&Object.prototype.hasOwnProperty.call(n.data,t)))throw new Error(`Miss [${t}] in execute return value but declare in resultType`)})}async function he(n,e){let r=z("field"),t=X(r.field?.authorizations??[],r.domainList??[]),o=r.field?.resultType,a=await r?.field?.execute(n,{...e,fetch:t});return de(a,o),console.log(a),a}async function fe(n,e,r){let t=z(),{itemId:o}=r,a=t.action?.formItems?.find(i=>i.itemId===o);if(typeof a?.autocomplete=="function"){let i=a.autocomplete,g=await i(n,e,r);console.log(g)}else console.error(`Can not find autocomplete function in formItem with itemId ${o}`)}var ye=Y;async function Ae(n){return Object.assign({logID:"",timeZone:"",tenantKey:"",fetch:y.default},n)}async function ke(n){let e=process.cwd(),{appId:r}=require(A.default.join(e,"../app.json")),{blockTypeID:t}=require(A.default.join(e,"block.json"));return Object.assign({app:{token:"",logID:"",trigger:{type:"AddRecordTrigger"}},packID:r,extensionID:t,fetch:y.default,tenantAccessToken:"",tenantKey:""},n)}function xe(n,e){let r=`<%${n}%>`;if(e){let t=Object.keys(e).reduce((o,a)=>{let i=e[a];return i.type==="icon"?o[a]=Object.assign(i,{url:i.src}):o[a]=i,o},{});return{text:r,param:t}}return r}async function Te(n,e){let{context:r}=e,{tenantAccessToken:t}=r;if(!(r.app||r.bitable)?.token)throw new Error("app.token is empty, please config it to context in test/index file");if(!t)throw new Error("tenantAccessToken is empty, please config it to context in test/index file");return new C(n,e).upload()}var C=class{constructor(e,r){this.CHUNK_SIZE=4*1024*1024;this.SEQ_SIZE=20*1024*1024;this.maxRetries=10;this.options=r,this.attachments=e;let{tenantAccessToken:t}=r.context,o=`Bearer ${t}`;this.Authorization=o,typeof r.retry=="number"&&(this.maxRetries=r.retry)}async upload(){let{attachments:e,SEQ_SIZE:r}=this,t=[];for(let o=0;o<e.length;o++){let a=e[o],i=a.file.length>=r?await this.uploadLargeFile(a):await this.uploadFile(a);t.push(i)}return t}async uploadFile(e,r=0){let{options:t}=this,{context:o}=t,{fetch:a,tenantAccessToken:i}=o,c=(o.app||o.bitable)?.token,{name:p,file:h}=e,l=h.length,m=new M.default;m.append("file_name",p),m.append("parent_type","bitable_file"),m.append("parent_node",c),m.append("size",l),m.append("file",h);let u=m.getHeaders(),d=`https://${this.getDomain()}/open-apis/drive/v1/medias/upload_all`,T=await a(d,{method:"POST",headers:{Authorization:`Bearer ${i}`,...u},body:m}),O=T.headers.get("x-ogw-ratelimit-reset");if(O){if(r<this.maxRetries)return new Promise((F,ee)=>{let _=parseInt(O,10)*1e3;console.log(`Retrying in ${_} seconds.`),setTimeout(()=>{this.uploadFile(e,r+1).then(F).catch(ee)},_)});throw new Error(`Retrying 3 times failed. ${this.createMsg("Refer to the documentation to fix the error: https://open.feishu.cn/document/server-docs/api-call-guide/frequency-control","Refer to the documentation to fix the error: https://open.larksuite.com/document/server-docs/getting-started/frequency-control","Please try again later.")}`)}let E=await T.json(),L=E.data?.file_token;if(!L)throw console.warn("Upload file fail, you can check if your app is added to Base First"),new Error(this.createErrorMsg(E));return this.generateAttachment(e,L)}createMsg(e,r,t){let{env:o}=this.options;return o==="feishu"?e:o==="lark"?r:t}createErrorMsg(e){try{return JSON.stringify(e,void 0,2)}catch{return"Stringify upload result fail"}}generateAttachment(e,r){let t=e.mimeType||H.default.getType(e.name);if(!t)throw new Error("Can not parse the mineType from file name");return{id:r,attachmentToken:r,name:e.name,mimeType:t,size:e.file.length,timeStamp:Math.floor(Date.now()/1e3)}}getDomain(){let{env:e="feishu"}=this.options;return{feishu:"open.feishu.cn",lark:"open.larksuite.com"}[e]||e}async uploadLargeFile(e){let r=await this.uploadPrepare(e);await this.uploadChunks(e,r.upload_id);let t=await this.uploadFinish(r);return this.generateAttachment(e,t)}async uploadFinish(e){let{Authorization:r}=this,t=this.getDomain();return(await(0,y.default)(`https://${t}/open-apis/drive/v1/medias/upload_finish`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:r},body:JSON.stringify(e)}).then(a=>a.json())).data.file_token}async uploadPrepare(e){let{options:r,Authorization:t}=this,{name:o,file:a}=e,g=(r.context.app||r.context.bitable)?.token,c=JSON.stringify({file_name:o,parent_type:"bitable_file",parent_node:g,size:a.length}),p=this.getDomain();return(await(0,y.default)(`https://${p}/open-apis/drive/v1/medias/upload_prepare`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t},body:c}).then(l=>l.json())).data}async uploadChunks(e,r){let{CHUNK_SIZE:t}=this,{file:o}=e,a=Math.ceil(o.length/t),i=[];for(let g=0;g<a;g++){let c=await this.uploadChunk(e,g,r);i.push(c)}return i}async uploadChunk(e,r,t,o=0){let{Authorization:a,maxRetries:i,CHUNK_SIZE:g}=this,{file:c,name:p}=e,h=r*g,l=Math.min(h+g,c.length),m=c.slice(h,l),u=new M.default;u.append("upload_id",t),u.append("seq",r),u.append("size",l-h),u.append("file",m,p);let f=u.getHeaders();try{let d=this.getDomain();await(0,y.default)(`https://${d}/open-apis/drive/v1/medias/upload_part`,{method:"POST",headers:{Authorization:a,...f},body:u}).then(T=>T.json())}catch{if(o>=i)throw new Error(`Failed to upload chunk ${r} after ${i} retries`);return this.uploadChunk(e,r,t,o+1)}}};function be(n){return n.map(e=>({name:e}))}function Ie(n){let{tableId:e,viewId:r,recordId:t,fieldId:o}=n;if(!e||!r||!n.url)throw new Error("\u300C tableId,viewId,url \u300D can not be empty");let a=new URL(n.url);return a.searchParams.set("table",e),a.searchParams.set("view",r),t&&a.searchParams.set("record",t),o&&a.searchParams.set("field",o),a.toString()}function x(n,e){let r=R.default.parse(n,!0);return delete r.search,Object.assign(r.query,e),R.default.format(r)}var j=process.cwd();function X(n,e){return async function(t,o,a){let i="";typeof t=="string"?i=t:typeof t.href=="string"?i=t.href:typeof t.url=="string"&&(i=t.url);let g=Re(i);if(!e?.some(p=>g.endsWith(p)))throw new Error(`${i} is not in request whitelist, please config the domainList`);let c=Array.isArray(n)&&n.find(p=>p.id===a);if(c){let p=n?.findIndex(m=>m.id===a),h=require(A.default.join(j,"config.json"));if(!h)throw new Error(`Miss config.json file in ${j}`);if(!h.authorizations?.[p])throw new Error("Miss authorizations in config.json");o||(o={});let l=h.authorizations[p];switch(c.type){case"Basic":{if(!l.username)throw new Error(`Miss authorizations[${p}.]username in config.json`);if(!l.password)throw new Error(`Miss authorizations[${p}.]password in config.json`);let u=Buffer.from(`${l.username}:${l.password}`,"utf-8").toString("base64");o={...o,headers:{...o.headers,Authorization:`Basic ${u}`}};break}case"HeaderBearerToken":{o={...o,headers:{...o.headers,Authorization:`Bearer ${l}`}};break}case"OAuth2":{o={...o,headers:{...o.headers,Authorization:`Bearer ${l}`}};break}case"CustomHeaderToken":{c.params?.headerName&&(o={...o,headers:{...o.headers,[c.params.headerName]:l}});break}case"MultiHeaderToken":{if(Array.isArray(c.params)&&c.params.length>0){let m=c.params.reduce((u,f,d)=>(u[f.key]=l?.[d],u),{});o={...o,headers:{...o.headers,...m}}}break}case"QueryParamToken":{c.params?.paramName&&(typeof t=="string"?t=x(t,{[c.params.paramName]:encodeURIComponent(l)}):typeof t.href=="string"?t.href=x(t.href,{[c.params.paramName]:encodeURIComponent(l)}):typeof t.url=="string"&&(t.url=x(t.url,{[c.params.paramName]:encodeURIComponent(l)})));break}case"MultiQueryParamToken":{if(Array.isArray(c.params)&&c.params.length>0){let m=c.params.reduce((u,f,d)=>(u[f.key]=encodeURIComponent(l?.[d]),u),{});typeof t=="string"?t=x(t,m):typeof t.href=="string"?t.href=x(t.href,m):typeof t.url=="string"&&(t.url=x(t.url,m))}break}case"Custom":{if(Array.isArray(c.params)&&c.params.length>0){let m=c.params.reduce((u,f,d)=>(u[f.key]=encodeURIComponent(l?.[d]),u),{});typeof t=="string"?t=I(t,m):typeof t.href=="string"?t.href=I(t.href,m):typeof t.url=="string"&&(t.url=I(t.url,m)),typeof o?.body=="string"&&(o.body=I(o.body,m))}break}}}return(0,y.default)(t,o)}}function I(n,e){return n.replace(/{{\s*(\S+?)\s*}}/g,(t,o)=>e[o]??t)}function Re(n){return R.default.parse(n).hostname??n}0&&(module.exports={AuthorizationType,Basekit,Component,DateFormatter,FieldCode,FieldComponent,FieldComponentEnum,FieldType,NextStep,NumberFormatter,ParamType,StructureType,TriggerType,base,basekit,bitable,createActionContext,createFetch,createFieldContext,execute,field,generateOptions,getBasekitUrl,newPack,t,testAction,testActionAutocomplete,testField,uploadAttachments});
