"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(r,a){function s(e){try{p(i.next(e))}catch(e){a(e)}}function n(e){try{p(i.throw(e))}catch(e){a(e)}}function p(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,n)}p((i=i.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const crypto_1=__importDefault(require("crypto")),fs_1=__importDefault(require("fs")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),compile_error_1=require("../../common/compile-error"),api_1=require("../../config/api"),common_1=require("../../config/common"),protocol_1=require("../../protocol"),preview_1=require("../../protocol/preview"),commonData_1=require("../../types/commonData"),preview_2=require("../../types/preview"),upload_1=require("../../types/upload"),timer_1=__importDefault(require("../../utils/timer")),utils_1=require("../../utils/utils"),eventTrackDef_1=require("../eventTracker/eventTrackDef"),Upload_1=__importDefault(require("../upload/help/Upload")),index_1=__importDefault(require("./index")),util_1=require("./util");class LivePreviewModule extends index_1.default{constructor(){super(...arguments),this.isFirstCompile=!0,this.fromSPA=!1,this.isDebug=!1}getPackageHash(e){const t=fs_1.default.readFileSync(e),o=crypto_1.default.createHash("md5");return o.update(t),o.digest("hex")}compileFail(e){return this.emitProgress({step:"Preview failed",done:!0,status:"fail"}),this.log("error",preview_1.CmdEnum.previewGadget,"common","fail",e),e}getPreviewUrl(e,t,o,i,r,a,s,n,p){if(this.log.bind(this,"info","miniprogramUrl")("receiveParams","end",{type:e,appid:t,appType:o,url:i,version:r,urlParams:a,startPage:p}),o===commonData_1.AppTypeEnum.Block)return`https://applink.feishu.cn/client/block/open?app_id=${t}&version=v2&version_type=preview&isdev=1&useCache=0&preview_type=device_preview`;const l=p?`&start_page=${encodeURIComponent(p)}&path=${encodeURIComponent(p)}`:"",c=JSON.stringify(Object.assign({version:r,url:i,id:t,wsUrl:"",url_v2:i,isLocal:1,pcUseMobilePkg:"0",ide_disable_domain_check:s?0:1,gadgetSafeUrls:n},a));switch(e){case preview_2.GadgetMobileMode.Mobile:return`sslocal://microapp?version=v2&app_id=${t}&version_type=preview&url=${encodeURIComponent(i)}&isdev=1&useCache=0${l}&ide_disable_domain_check=${s?0:1}`;case upload_1.GadgetPCMode.Window:case upload_1.GadgetPCMode.AppCenter:case upload_1.GadgetPCMode.Sidebar:case upload_1.GadgetPCMode.WindowSemi:return`lark://mini-program/open?mode=${util_1.PCModeMap[e]}&appId=${t}&url=${encodeURIComponent(c)}&isDev=1${l}`}}onGadgetCompileEnd(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info","onGadgetCompileEnd");t("receiveParams","end",{options:e});const{message:o,productName:i}=e;try{const e=this.previewType===preview_2.GadgetMobileMode.Mobile,r=Math.random().toString().slice(2,7),a=`${r}${e?common_1.PKGFileSuffix:common_1.zipSuffix}`,{appId:s,serverUrl:n,targetPath:p,compilePath:l,startPage:c,enableWebviewSafeDomain:d,gadgetSafeUrls:m}=this.launchOptions,u=path_1.default.join(p,a),_=n+a,h=path_1.default.join(p,e?i:"__dist__.zip"),v=this.getComponentList(path_1.default.dirname(u));if(o)return this.emitProgress({step:"Preview failed",done:!0,status:"fail"}),void this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:o});if(!fs_1.default.existsSync(h))return;t("renamePackagePath","start",{originPackagePath:h,packagePath:u}),yield fs_1.default.promises.rename(h,u),t("renamePackagePath","end");const g={},f=this.getPreviewUrl(this.previewType,s,commonData_1.AppTypeEnum.Gadget,_,r,g,d,m,c);t("livePreviewGadget","start");const w=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.livePreviewGadget,Object.assign({appId:s,preview_url:f,md5:this.getPackageHash(u),pkg_url:_,type:this.isFirstCompile&&e?"qrcode":"push",components:v},(0,util_1.getDebugInfo)(this.execute,l,"gadget")),{responseCode:!0,logId:!0});t("livePreviewGadget","end",{response:w.data}),Upload_1.default.checkUploadResponds(w),this.emitProgress({step:`Preview on ${e?"mobile":"PC"} succeed`,done:!0,status:"success"}),this.isFirstCompile?(this.isFirstCompile=!1,w.data.url&&this.displayQRCode(w.data.url),this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:(e?"You can scan QR code to preview the gadget.\nYou need to keep the current device and mobile in the same LAN.\n":"")+"Code modification is watching..."}),this.emit(preview_1.EventEnum.previewed,{schemaUrl:w.data.url})):this.emit(preview_1.EventEnum.previewed,{}),this.updateLastPreviewTime(l,{url:w.data.url,watch:!0,platform:e?upload_1.GadgetPlatform.Mobile:upload_1.GadgetPlatform.PC}),t("onHandleCompileEnd","end")}catch(e){t("onHandleCompileEnd","end",{error:e});const o=this.compileFail(e);if(!this.fromSPA)throw o;this.emit(preview_1.EventEnum.previewError,{error:o})}}))}registerEvents(e){e.addEventListener(protocol_1.ModuleName.compile,protocol_1.CompileEventEnum.WatchCompileStart,e=>{e.data&&e.data.appType!==commonData_1.AppTypeEnum.Gadget||e.data&&"live"!==e.data.from||(this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:"File changed"}),this.emitProgress({step:"Compiling"}))}),e.addEventListener(protocol_1.ModuleName.compile,protocol_1.CompileEventEnum.WatchCompileEnd,e=>{if(e.data&&e.data.appType===commonData_1.AppTypeEnum.Gadget&&this.launchOptions&&"live"===e.data.from){const{errMsg:t,data:o}=e;this.onGadgetCompileEnd({message:t,productName:(null==o?void 0:o.productName)||""})}})}[preview_1.CmdEnum.previewGadget](e){const t=e=>super[e];return __awaiter(this,void 0,void 0,(function*(){const o=this.log.bind(this,"info",preview_1.CmdEnum.previewGadget);if(!(e.watch||e.debug&&e.platform===upload_1.GadgetPlatform.PC))return t(preview_1.CmdEnum.previewGadget).call(this,e);this.isFirstCompile=!0,e.fromSPA&&(this.fromSPA=!0),this.isDebug=!!e.debug,o("livePreview","start",e);const i={platform:e.platform};try{const{appId:t,compilePath:r}=yield Upload_1.default.prepareCheck(e.compilePath,e.appId,this.execute);o("check","end",t,r);const a=yield Upload_1.default.choosePlatform(e.platform,this.execute),s=Upload_1.default.isPCPlatform(a);o("choosePlatform","end",a),s?(this.previewType=yield this.choosePCMode(e.mode),o("choosePCMode","end",this.previewType)):this.previewType=preview_2.GadgetMobileMode.Mobile,this.emitProgress({step:"Compiling"}),yield this.execute(protocol_1.ModuleName.compile,protocol_1.CompileCmdEnum.SetPath,r);const n=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,r,"gadget","tmpConfig").livePreviewDist;let p;try{timer_1.default.start("gadget_preview_start_httpserver"),o("startHTTPServer","start",{targetPath:n,previewType:this.previewType}),p=(0,utils_1.startHTTPServer)(n,this.previewType===preview_2.GadgetMobileMode.Mobile),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_start_httpserver",Object.assign(Object.assign({},timer_1.default.end("gadget_preview_start_httpserver")),i)),o("startHTTPServer","end")}catch(e){throw o("startHTTPServer","end",{error:e}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_start_httpserver",Object.assign(Object.assign(Object.assign({},timer_1.default.end("gadget_preview_start_httpserver")),i),{error:e})),e}const l=[],c=(!s||(0,common_1.featureGating)(common_1.FeatureGatingKeys.enableWebviewSafeDomain))&&!!e.enableWebviewSafeDomain;if(s&&c)try{const{gadget_safe_url:e=[]}=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getSafeSetting,{appId:t});l.push(...e)}catch(e){o("getWebviewSafeDomain","livePreview","fail",{e:e})}this.launchOptions={appId:t,serverUrl:p,targetPath:n,compilePath:r,enableWebviewSafeDomain:c,gadgetSafeUrls:l,startPage:e.startPage},o("livePreview","launch",this.launchOptions);const{error:d}=yield this.execute(protocol_1.ModuleName.compile,protocol_1.CompileCmdEnum.Compile,{from:"live",type:a,compilePath:r,packageType:"mobile"===a?"PKG":"ZIP"});if(console.log("compile end",d),d)throw new compile_error_1.CompileError(d);o("compile","success",r)}catch(e){throw o("compile","error",e),this.compileFail(e)}}))}[preview_1.CmdEnum.pushDebugMsg](e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info",preview_1.CmdEnum.pushDebugMsg);try{t("receiveParams","start",{options:e});const{appId:o,appType:i=commonData_1.AppTypeEnum.Gadget,serverUrl:r,targetPath:a,compilePath:s,productName:n,previewType:p,wsForDebug:l,extensionId:c,debugPreviewType:d,previewPlatform:m,enableWebviewSafeDomain:u,startPage:_,traceId:h}=e,v=p===preview_2.GadgetMobileMode.Mobile,g=Math.random().toString().slice(2,7),f=`${g}${"mobile"===m&&i!==commonData_1.AppTypeEnum.Block?common_1.PKGFileSuffix:common_1.zipSuffix}`,w=path_1.default.join(a,f),P=r+"/"+f,y=path_1.default.join(a,n||""),b=i===commonData_1.AppTypeEnum.Block?[]:this.getComponentList(path_1.default.dirname(w));yield fs_1.default.promises.copyFile(y,w),h&&this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.debug,{},h,"debug_copy");const C=[],E=("mobile"===m||(0,common_1.featureGating)(common_1.FeatureGatingKeys.enableWebviewSafeDomain))&&u;if("pc"===m&&E)try{const{gadget_safe_url:e=[]}=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getSafeSetting,{appId:o});C.push(...e)}catch(e){t("getWebviewSafeDomain","debugPreview","fail",{e:e})}const T=this.getPreviewUrl(p,o,i,P,g,e.previewPlatform===upload_1.GadgetPlatform.Mobile?{}:{ws_for_debug:e.wsForDebug},E,C,_);let M={};l&&d&&(M={preview_type:d,socket_address:l});const k=Object.assign(Object.assign({appId:o,extension_id:c,preview_url:T,md5:this.getPackageHash(w),pkg_url:P,type:v?"qrcode":"push",components:b,extension_type:i===commonData_1.AppTypeEnum.Block?"gadget_block":void 0},M),(0,util_1.getDebugInfo)(this.execute,s,i===commonData_1.AppTypeEnum.Block?"block":"gadget"));t("livePreviewGadget","start",{params:k});const S=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.livePreviewGadget,k,{responseCode:!0,logId:!0,traceId:h});return t("livePreviewGadget","end",{response:S.data}),Upload_1.default.checkUploadResponds(S),h&&this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.debug,{},h,"debug_request"),S.data.url}catch(e){throw e}}))}getComponentList(e){const t=path_1.default.join(e,"__components__","component.json");return fs_extra_1.default.existsSync(t)?fs_extra_1.default.readJSONSync(t).map(e=>({name:e})):[]}}exports.default=LivePreviewModule;