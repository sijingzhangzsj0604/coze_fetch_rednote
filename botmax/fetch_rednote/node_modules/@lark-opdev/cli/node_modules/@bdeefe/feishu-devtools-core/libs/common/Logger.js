"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.logger=void 0;const path_1=__importDefault(require("path")),log4js_1=__importDefault(require("log4js")),uuid_1=require("uuid"),protocol_1=require("../types/protocol"),glob_1=__importDefault(require("glob")),DefaultConfig=Object.freeze({appenders:[],logPath:""});class Logger{constructor(e){if(!process.env.DISABLE_LOG){if(Logger.isInit||(Logger.isInit=!0,Logger.configure()),Logger.Config.logPath===DefaultConfig.logPath)throw new Error("WARN: 日志的输出路径 logPath 在还没有定义前就进行了调用");this.logger=log4js_1.default.getLogger(),this.logger.addContext("module",e),this.debugLogger=log4js_1.default.getLogger("debug")}}log(e,...t){var o,g,r,l;if(process.env.DISABLE_LOG)return;const a=e.toLowerCase();let s=t;s[0][0]>="A"&&s[0][0]<="Z"&&Object.keys(protocol_1.ModuleName).includes(s[0])&&(null===(o=this.logger)||void 0===o||o.addContext("module",s[0]),s=s.slice(1)),null===(g=this.logger)||void 0===g||g.addContext("scene",s[0]),null===(r=this.logger)||void 0===r||r.addContext("step",s[1]),null===(l=this.logger)||void 0===l||l.addContext("status",s[2]);const i=s.slice(2).map(e=>"object"==typeof e?JSON.stringify(e):null==e?void 0:e.toString()).join(" ");this.logger&&this.logger[a](i)}trace(...e){var t;null===(t=this.debugLogger)||void 0===t||t.trace(e)}debug(...e){var t;null===(t=this.debugLogger)||void 0===t||t.debug(e)}info(...e){this.log("INFO",...e)}warn(...e){this.log("WARN",...e)}error(...e){this.log("ERROR",...e)}fatal(...e){this.log("FATAL",...e)}getLogs(e){const t=path_1.default.join(Logger.Config.logPath,"logs"),o=e.getFullYear(),g=(""+(e.getMonth()+1)).padStart(2,"0"),r=(""+e.getDate()).padStart(2,"0");return console.log({yyyy:o,MM:g,dd:r}),new Promise((e,l)=>{(0,glob_1.default)(`*.${o}-${g}-${r}.log*`,{cwd:t},(o,g)=>{o?l(o):e(g.map(e=>path_1.default.join(t,e)))})})}}Logger.isInit=!1,Logger.Config=DefaultConfig,Logger.configure=(()=>{let e=!1;const t=(0,uuid_1.v4)();return()=>{if("development"===process.env.NODE_ENV&&Logger.Config===DefaultConfig)throw new Error("please set Logger static Config");if(e)return;const o=path_1.default.join(Logger.Config.logPath,"logs"),g={type:"pattern",pattern:"%d{yyyy-MM-dd hh:mm:ss.SSS} %x{traceId} [%X{module}][%X{scene}.%X{step}.%X{status}] %p %m%n",tokens:{traceId:()=>t}};log4js_1.default.configure({appenders:{stdout:{type:"stdout"},file:{type:"dateFile",filename:path_1.default.join(o,"run"),pattern:"yyyy-MM-dd.log",alwaysIncludePattern:!0,maxLogSize:2097152,backups:100,layout:g}},categories:{default:{level:"INFO",appenders:"DEBUG"===process.env.env?Logger.Config.appenders.concat("file"):["file"],enableCallStack:!1},debug:{level:"trace",appenders:["stdout"],enableCallStack:!1}}}),e=!0}})(),exports.default=Logger;const logger=()=>new Logger("Common");exports.logger=logger;