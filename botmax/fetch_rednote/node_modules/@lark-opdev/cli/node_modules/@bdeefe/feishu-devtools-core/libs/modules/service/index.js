"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,s)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(s,i){function r(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(r,a)}u((n=n.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),node_1=__importDefault(require("@lark-opdev/i18n/libs/node")),Error_1=__importStar(require("../../common/Error")),Module_1=__importDefault(require("../../common/Module")),api_1=require("../../config/api"),common_1=require("../../config/common"),env_1=require("../../config/env"),protocol_1=require("../../protocol"),service_1=require("../../protocol/service"),protocol_2=require("../../types/protocol"),Request_1=__importDefault(require("./help/Request"));class ServiceModule extends Module_1.default{constructor(){super(protocol_2.ModuleName.service),this.larkSession={},this.proxy={type:"direct",proxy:{}},this.customHeaders={},this.v5URLList=[]}formatLarkSession(e,t){return`session=${e}; session_list=${t.join("_")}`}created(){return __awaiter(this,void 0,void 0,(function*(){yield this[service_1.CmdEnum.Init]()}))}updateCustomHeaders(){var e;const t=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"settings");"feishu-boe"===this.environment||"lark-boe"===this.environment||"feishu-pre"===this.environment||"lark-pre"===this.environment?this.customHeaders=null!==(e=null==t?void 0:t.customHeaders)&&void 0!==e?e:{}:this.customHeaders={}}[service_1.CmdEnum.Init](){var e,t;return __awaiter(this,void 0,void 0,(function*(){const o=this.log.bind(this,"info",service_1.CmdEnum.Init),n=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"accountInfo");if(o("getAccountInfo","end",{accountInfo:n}),null==n?void 0:n.env)this.environment=n.env;else{const{id:e}=yield(0,env_1.getEnv)();this.environment=e}o("initEnvironment","end",{environment:this.environment}),(null==n?void 0:n.larkSession)&&(this.larkSession.ide=this.formatLarkSession(n.larkSession,n.larkSessionList||[])),o("larkSession","end",{larkSession:this.larkSession});const s=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"settings");this.proxy={type:(null===(e=null==s?void 0:s.proxy)||void 0===e?void 0:e.type)||"direct",proxy:(null===(t=null==s?void 0:s.proxy)||void 0===t?void 0:t.proxy)||{}},o("initProxy","end",{proxy:this.proxy});try{const{data:e}=fs_extra_1.default.readJSONSync(path_1.default.join(this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"),common_1.configManager.config.updateFile)),{v5URLList:t=[]}=e;this.v5URLList=t}catch(e){o("service","v5ReadFail",{message:e.message})}this.updateCustomHeaders()}))}[service_1.CmdEnum.Update](e){const t=this.log.bind(this,"info",service_1.CmdEnum.Update);if(e.environment&&(this.environment=e.environment,this.updateCustomHeaders()),t("environmentUpdated","end",{environment:this.environment}),e.larkSession){const o=this.formatLarkSession(e.larkSession,e.larkSessionList||[]);"debug"===e.type?this.larkSession.debug=o:this.larkSession.ide=o,t("larkSessionUpdated","end",{type:e.type,larkSession:o})}}[service_1.CmdEnum.GetEnvironment](){return{environment:this.environment}}[service_1.CmdEnum.GetV5URLList](){return{v5URLList:this.v5URLList}}[service_1.CmdEnum.SetV5URLList](e){this.v5URLList=e}[service_1.CmdEnum.SetProxy](e){this.log.bind(this,"info",service_1.CmdEnum.SetProxy)("receiveProxyConfig","end",{proxyConfig:e}),this.proxy=e}[service_1.CmdEnum.SetCustomHeaders](e){this.log.bind(this,"info",service_1.CmdEnum.SetCustomHeaders)("receiveCustomHeaders","end",{customHeaders:e}),this.customHeaders=e}[service_1.CmdEnum.Request](e,t,o){var n,s,i;const r=(e,...t)=>{this.log(e,service_1.CmdEnum.Request,...t)},a=null!==(n=null==o?void 0:o.headers)&&void 0!==n?n:{};Object.assign(a,this.customHeaders),(null==o?void 0:o.traceId)&&(a["X-Tt-Logid"]=null!==(s=a["X-Tt-Logid"])&&void 0!==s?s:o.traceId),a["Accept-Language"]=a["Accept-Language"]||node_1.default.getLang(),a["User-Agent"]=a["User-Agent"]||"opdev-ide/3.2.0";const u="debug"===e.sessionType&&null!==(i=this.larkSession.debug)&&void 0!==i?i:this.larkSession.ide,d=e.key;d&&(0,common_1.featureGating)("opdev.request.v5")&&this.v5URLList.includes(d)&&api_1.newAPI[d]&&(e.type=api_1.newAPI[d].type,e.method=api_1.newAPI[d].method,e.subDomain=api_1.newAPI[d].subDomain,e.sessionType=api_1.newAPI[d].sessionType,e.url=api_1.newAPI[d].url);const c=new Request_1.default(Object.assign(Object.assign({baseURL:(0,api_1.getBaseURL)(this.environment,e.type,e.subDomain)},o),{headers:u?Object.assign({Cookie:u},a):a,logger:r,hooks:{sessionExpired:()=>{r("info","onHookSessionExpired","end"),this.execute(protocol_2.ModuleName.account,protocol_1.AccountCmdEnum.Logout,{skipConfirm:!0,sessionExpired:!0})},checkLoginStatus:()=>!!this.execute(protocol_2.ModuleName.account,protocol_1.AccountCmdEnum.Info)}}));return new Promise((n,s)=>{c.fetch(e.url,{method:e.method,data:t,proxy:this.proxy,timeout:null==o?void 0:o.timeout}).then(n).catch(e=>{if(r("info","request","end",e),"ENOTFOUND"===e.code)s(new Error(`Unable to access ${e.hostname}, please check the network`));else if(e.response&&e.response.status){const t=e.response.status.toString();"4"===t[0]||"5"===t[0]?(s(new Error_1.default({code:Error_1.CoreErrorCode.REQUEST_ERROR,status:e.response.status,message:`[${e.response.status}] ${e.response.data.message||e.response.data.msg||"unknown"}, URL: ${e.config.baseURL}${e.config.url}, Log ID: ${e.response.headers["x-tt-logid"]}. Run opdev feedback and provide the above information for more help`})),r("error","request","finish",e.response.status,e.response.headers,e.response.data)):s(e)}else s(e)})})}}exports.default=ServiceModule;