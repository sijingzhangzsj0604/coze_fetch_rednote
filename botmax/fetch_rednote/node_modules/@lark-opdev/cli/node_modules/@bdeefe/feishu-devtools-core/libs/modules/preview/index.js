"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,a)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(a,i){function d(e){try{l(o.next(e))}catch(e){i(e)}}function s(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(d,s)}l((o=o.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),node_1=__importDefault(require("@lark-opdev/i18n/libs/node")),Error_1=__importStar(require("../../common/Error")),Module_1=__importDefault(require("../../common/Module")),common_error_1=require("../../common/common-error"),compile_error_1=require("../../common/compile-error"),request_error_1=require("../../common/request-error"),unknown_error_1=require("../../common/unknown-error"),api_1=require("../../config/api"),env_1=__importDefault(require("../../config/env")),protocol_1=require("../../protocol"),preview_1=require("../../protocol/preview"),upload_1=require("../../types/upload"),timer_1=__importDefault(require("../../utils/timer")),utils_1=require("../../utils/utils"),eventTrackDef_1=require("../eventTracker/eventTrackDef"),Upload_1=__importDefault(require("../upload/help/Upload")),util_1=require("./util");class PreviewModule extends Module_1.default{constructor(){super(protocol_1.ModuleName.preview)}choosePCMode(e){this.log.bind(this,"info","choosePCMode")("receiveParams","end",{defaultPCMode:e});const t=Object.entries(upload_1.GadgetPCMode),r=t.map(e=>e[1]);if(e){if(r.includes(e))return Promise.resolve(e);throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:node_1.default.t("PARAM_ERROR_PCMODE_INVALID",{advisePCModeIds:r.join(", ")})})}return this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.pick,t.map(([e,t])=>({name:e,value:t})),"Please choose PC mode")}emitProgress(e){this.onProgress(e),this.emit(preview_1.EventEnum.progress,e)}genQcodePage(e){const t=this.log.bind(this,"info","genQcodePage"),r=path_1.default.join(__dirname,"..","..","pages","preview.html");t("getHtmlPath","end",{htmlPath:r});const o=fs_1.default.readFileSync(r).toString();return fs_1.default.writeFileSync(r,o.replace(new RegExp("<script>window.__QRCODE.*?<\/script>"),`<script>window.__QRCODE='${e}';<\/script>`)),r}getGadgetFormData(e){const t={};if(Upload_1.default.isPCPlatform(e.platform)&&e.mode){const r=util_1.PCModeMap[e.mode];t.mode=r,t.url_prefix=`lark://mini-program/open?mode=${r}&ide_disable_domain_check=${e.enableWebviewSafeDomain?0:1}`,t.unneed_msg=e.unneedMsg?"true":"false"}return t.start_page=encodeURIComponent(e.startPage),t.source=fs_1.default.createReadStream(e.packagePath),t.miniMode=e.miniMode,e.debug_info&&(t.debug_info=JSON.stringify(e.debug_info)),t}updateLastPreviewTime(e,t){var r;const o=Date.now(),{url:a,watch:i,platform:d=upload_1.GadgetPlatform.Mobile}=t,s=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,e,"gadget","simulatorConfig"),l=Object.assign(Object.assign({},s),{lastPreview:{time:o}});if(d===upload_1.GadgetPlatform.Mobile){const e=null===(r=null==s?void 0:s.lastMobilePreview)||void 0===r?void 0:r.url;l.lastMobilePreview={url:a||e,time:o,watch:i}}else l.lastPCPreview={time:o,watch:i};this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Set,e,"gadget","simulatorConfig",l)}showQRCodeUrl(e){this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:"The URL of QR code:"}),this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:e})}[preview_1.CmdEnum.previewGadget](e){var t;return __awaiter(this,void 0,void 0,(function*(){const r=this.log.bind(this,"info",preview_1.CmdEnum.previewGadget);r("preview","start",e);const o=[],a={appId:e.appId,platform:e.platform,mode:e.mode};let i=upload_1.GadgetPlatform.Mobile;try{timer_1.default.start("gadget_preview_upload_total");const d="preview",{appId:s,compilePath:l}=yield Upload_1.default.prepareCheck(e.compilePath,e.appId,this.execute);r("check","success",s,l),i=yield Upload_1.default.choosePlatform(e.platform,this.execute);const c=Upload_1.default.isPCPlatform(i);let n,p;r("choosePlatform","success",i),c&&(n=yield this.choosePCMode(e.mode),r("choosePCMode","success",n)),this.emitProgress({step:"Compressing"});try{timer_1.default.start("gadget_preview_upload_compress"),r("compress","start");try{p=yield Upload_1.default.compress({version:d,platform:i,compilePath:l,appId:s,appType:"gadget",useNPM:e.useNPM},this.execute)}catch(e){if(e.code!==Error_1.CoreErrorCode.PARAM_ERROR||!e.advise)throw new common_error_1.CommonError(Error_1.CoreErrorCode.CORE_MODULE_ERROR,2300000002,e.message,e.code,e.stack);p=e.advise,o.push(e.toString())}r("compress","end"),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_compress",Object.assign(Object.assign({},timer_1.default.end("gadget_preview_upload_compress")),a)),e.traceId&&this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.preview,{},e.traceId,"upload_compress"),r("preview","end")}catch(e){throw r("preview","end",{error:e}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_compress",Object.assign(Object.assign(Object.assign({},timer_1.default.end("gadget_preview_upload_compress")),a),{error:e})),e}const u=Object.assign({platform:i,mode:n,packagePath:p,miniMode:Upload_1.default.getMobileGadgetMode(l),startPage:e.startPage||"",enableWebviewSafeDomain:null===(t=e.enableWebviewSafeDomain)||void 0===t||t},(0,util_1.getDebugInfo)(this.execute,l,"gadget"));r("upload","start",u),this.emitProgress({step:"Uploading"});try{timer_1.default.start("gadget_preview_upload_emit");const t=yield Upload_1.default.upload(c?"previewPCGadget":"previewMobileGadget",s,this.getGadgetFormData(u),{traceId:e.traceId},this.execute);this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_emit",Object.assign(Object.assign({},timer_1.default.end("gadget_preview_upload_emit")),a)),e.traceId&&this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.preview,{},e.traceId,"upload_emit"),Upload_1.default.checkUploadResponds(t),r("upload","end")}catch(e){throw r("upload","end",{error:e}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_emit",Object.assign(Object.assign(Object.assign({},timer_1.default.end("gadget_preview_upload_emit")),a),{error:e})),(0,request_error_1.isRequestError)(e)?e:new common_error_1.CommonError(Error_1.CoreErrorCode.CORE_MODULE_ERROR,2200000001,e.message,e.code,e.stack)}try{r("checkCompileProgress","start",{appId:s}),timer_1.default.start("gadget_preview_upload_wait"),this.emitProgress({step:"Uploading",progress:0,version:"preview",identifier:"gadget-preview-"+i}),yield Upload_1.default.checkCompileProgress(s,"gadgetCompileProgress",this.execute,"gadget",i,e.traceId),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_wait",Object.assign(Object.assign({},timer_1.default.end("gadget_preview_upload_wait")),a)),this.emitProgress({step:"Uploading",done:!0,status:"success",identifier:"gadget-preview-"+i}),r("checkCompileProgress","end")}catch(e){throw r("checkCompileProgress","end",{error:e}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_wait",Object.assign(Object.assign(Object.assign({},timer_1.default.end("gadget_preview_upload_wait")),a),{error:e})),e}this.emitProgress({step:`Preview on ${c?"PC":"mobile"} succeed`,done:!0,status:"success"});let _="";if(c){if(this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:"You will receive card message, then click to preview"}),"cli"===env_1.default.renderType){if(_=yield Upload_1.default.getQRCodeUrl(s,d,u.startPage,"getPCGadgetQRCode",this.execute),!_)throw new Error_1.default({code:Error_1.CoreErrorCode.REQUEST_ERROR,message:node_1.default.t("GET_PREVIEW_LINK_FAILED")});r("qrcode","finish",_),this.showQRCodeUrl(_)}this.updateLastPreviewTime(l,{platform:upload_1.GadgetPlatform.PC,watch:!1})}else{if(r("getQRCodeUrl","start"),_=yield Upload_1.default.getQRCodeUrl(s,d,u.startPage,"getGadgetQRCode",this.execute),_=`${_}&ide_disable_domain_check=${e.enableWebviewSafeDomain?0:1}`,r("getQRCodeUrl","end",{schemaUrl:_}),!_)throw new Error_1.default({code:Error_1.CoreErrorCode.REQUEST_ERROR,message:node_1.default.t("GET_PREVIEW_LINK_FAILED")});yield this.displayQRCode(_),r("qrcode","finish",_),this.showQRCodeUrl(_),this.updateLastPreviewTime(l,{url:_,watch:!1})}return r("preview","success"),this.emit(preview_1.EventEnum.previewed,{schemaUrl:_,warnMsgs:o}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_total",Object.assign(Object.assign({},a),timer_1.default.end("gadget_preview_upload_total"))),e.traceId&&this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.preview,{},e.traceId,"upload_compiled"),{schemaUrl:_,warnMsgs:o}}catch(e){throw this.emitProgress({step:"Preview failed",done:!0,status:"fail",identifier:"gadget-preview-"+i}),this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"gadget_preview_upload_total",Object.assign(Object.assign(Object.assign({},a),timer_1.default.end("gadget_preview_upload_total")),{error:e})),this.log("error",preview_1.CmdEnum.previewGadget,"common","fail",e),(0,request_error_1.isRequestError)(e)||(0,compile_error_1.isCompileError)(e)||(0,common_error_1.isCommonError)(e)?e:new unknown_error_1.UnknownError(e.message,e.stack)}}))}[preview_1.CmdEnum.previewGadgetResume](e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info",preview_1.CmdEnum.previewGadgetResume);try{this.emitProgress({step:"Uploading",progress:0,identifier:"gadget-preview-"+e.platform}),yield Upload_1.default.checkCompileProgress(e.appId,"gadgetCompileProgress",this.execute,"gadget",e.platform),this.emitProgress({step:"Upload succeed",done:!0,status:"success",identifier:"gadget-preview-"+e.platform})}catch(r){throw t("checkCompileProgress","end",{error:r}),this.emitProgress({step:"Upload failed",done:!0,status:"fail",identifier:"gadget-preview-"+e.platform}),r}let r="";if("pc"===e.platform)this.updateLastPreviewTime(e.compilePath,{platform:upload_1.GadgetPlatform.PC,watch:!1});else{if(t("getQRCodeUrl","start"),r=yield Upload_1.default.getQRCodeUrl(e.appId,"preview",e.startPage||"","getGadgetQRCode",this.execute),r=`${r}&ide_disable_domain_check=${e.enableWebviewSafeDomain?0:1}`,t("getQRCodeUrl","end",{schemaUrl:r}),!r)throw new Error_1.default({code:Error_1.CoreErrorCode.REQUEST_ERROR,message:node_1.default.t("GET_PREVIEW_LINK_FAILED")});this.showQRCodeUrl(r),this.updateLastPreviewTime(e.compilePath,{url:r,watch:!1})}return t("preview","success"),{url:r}}))}[preview_1.CmdEnum.previewGadgetPlugin](e){return __awaiter(this,void 0,void 0,(function*(){const t=[],r=this.log.bind(this,"info",preview_1.CmdEnum.previewGadgetPlugin);this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Init),r("preview","start",e);try{const o="preview",{appId:a,compilePath:i}=yield Upload_1.default.prepareCheck(e.compilePath,e.appId,this.execute);r("check","success",a,i);const d=yield Upload_1.default.choosePlatform(e.platform,this.execute),s=Upload_1.default.isPCPlatform(d);let l;r("choosePlatform","success",d),s&&(l=yield this.choosePCMode(e.mode),r("choosePCMode","success",l)),this.emitProgress({step:"Compressing"});const c={platform:d,mode:l,packagePath:yield Upload_1.default.compress({version:o,platform:d,compilePath:i,appId:a,appType:"gadget",maxPkgSize:1/0},this.execute),miniMode:Upload_1.default.getMobileGadgetMode(i),startPage:e.startPage||"",enableWebviewSafeDomain:!1,unneedMsg:!0};r("upload","start:gadget",c),this.emitProgress({step:"Uploading"});const n=yield Upload_1.default.upload(s?"previewPCGadget":"previewMobileGadget",a,this.getGadgetFormData(c),{traceId:e.traceId},this.execute);Upload_1.default.checkUploadResponds(n),yield Upload_1.default.checkCompileProgress(a,"gadgetCompileProgress",this.execute,"gadget",d,e.traceId),r("upload","end:gadget","success");try{c.packagePath=yield Upload_1.default.compress({version:o,platform:d,compilePath:i,compileType:"plugin",appId:a,appType:"gadget",maxPkgSize:upload_1.MAX_PLUGIN_PACKAGE_SIZE},this.execute)}catch(e){if(e.code!==Error_1.CoreErrorCode.PARAM_ERROR||!e.advise)throw e;c.packagePath=e.advise,t.push(e.toString())}r("upload","start:gadgetPlugin",c);const p=yield Upload_1.default.upload("previewGadgetPlugin",a,this.getGadgetFormData(c),{traceId:e.traceId},this.execute);Upload_1.default.checkUploadResponds(p),yield Upload_1.default.checkCompileProgress(a,"gadgetPluginCompileProgress",this.execute,"gadget_plugin",d,e.traceId),r("upload","end:gadgetPlugin","success"),this.emitProgress({step:`Preview on ${s?"PC":"mobile"} succeed`,done:!0,status:"success"});const{url:u}=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getPreviewGadgetPlugin,Object.assign({appId:a,plugins:[{app_id:a}],start_page:c.startPage},(0,util_1.getDebugInfo)(this.execute,i,"gadget")),{traceId:e.traceId});if(!u)throw new Error_1.default({code:Error_1.CoreErrorCode.REQUEST_ERROR,message:node_1.default.t("GET_PREVIEW_LINK_FAILED")});return s||(yield this.displayQRCode(u),r("qrcode","finish",u),this.showQRCodeUrl(u)),this.updateLastPreviewTime(i,{platform:d,url:u,watch:!1}),r("preview","success"),this.emit(preview_1.EventEnum.previewed,{schemaUrl:u,warnMsgs:t}),{schemaUrl:u,warnMsgs:t}}catch(e){throw this.emitProgress({step:"Preview failed",done:!0,status:"fail"}),this.log("error",preview_1.CmdEnum.previewGadgetPlugin,"common","fail",e),e}}))}[preview_1.CmdEnum.previewH5](e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info",preview_1.CmdEnum.previewH5);t("receiveParams","end",{options:e});try{const{compilePath:r}=e;let o=r;const a=!r.includes("://");if(a){let a="",i="";if(!(0,utils_1.checkCompilePath)(r))throw new Error_1.default({code:Error_1.CoreErrorCode.COMPILE_PATH_ERROR,message:node_1.default.t("COMPILE_PATH_ERROR_PATH_INVALID")});fs_1.default.statSync(r).isDirectory()?(a=r,i=""):(a=path_1.default.dirname(r),i=path_1.default.basename(r)),t("startHTTPServer","start"),o=(0,utils_1.startHTTPServer)(a,e.platform===upload_1.GadgetPlatform.Mobile,[(e,t)=>{const r=e.url.slice(1)||"index.html";t.status(404).send(`Cannot find <b>${r}</b> in <b>${a}</b>`)}])+i,t("startHTTPServer","end",{previewUrl:o})}if(e.appId&&(t("checkAppId","start",{appId:e.appId}),yield Upload_1.default.checkAppId(e.appId,this.execute),t("checkAppId","end")),e.platform===upload_1.GadgetPlatform.Mobile){const r=`lark://client/web?isDev=1&url=${o}${e.appId?"&app_id="+e.appId:""}`;return t("displayQRCode","start",{schemaUrl:r}),yield this.displayQRCode(r),t("displayQRCode","end"),this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:"Preview on Mobile succeed, and debugging is not supported temporarily on mobile"}),{url:r}}return t("checkLogin","start"),Upload_1.default.checkLogin(this.execute),t("checkLogin","end"),yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.previewH5,{preview_url:o,app_id:e.appId},{traceId:e.traceId}),t("openPage","start"),this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.openPage,"lark://client/open"),this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:'Preview on PC succeed, and you can click the "More" button in the upper right corner of the client to open the DevTools'}),a&&this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.showInfo,{content:"Local server is still running..."}),{}}catch(e){throw e}}))}}exports.default=PreviewModule;