"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,a){function s(e){try{l(o.next(e))}catch(e){a(e)}}function n(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}l((o=o.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const ws_1=__importDefault(require("ws")),express_1=__importDefault(require("express")),qs_1=__importDefault(require("qs")),protocol_1=require("../../types/protocol"),protocol_2=require("../../protocol"),upload_1=require("../../types/upload"),performance_1=require("../../protocol/performance"),preview_1=require("../../types/preview"),eventTrackDef_1=require("../eventTracker/eventTrackDef"),utils_1=require("../../utils/utils"),port_1=require("../../utils/port"),Module_1=__importDefault(require("../../common/Module")),Upload_1=__importDefault(require("../upload/help/Upload"));class PerformanceModule extends Module_1.default{constructor(){super(protocol_1.ModuleName.performance),this.wsServer={},this.wsClient={connected:!1},this.fileServer={},this.msgBuffer={client:[],server:[]},this.tipTimeout=1e4}compile({from:e,compilePath:t,packageType:r,platform:o}){return __awaiter(this,void 0,void 0,(function*(){const i=this.log.bind(this,"info","compile");i("compile","start",{compilePath:t});const{distPath:a,error:s}=yield this.execute(protocol_1.ModuleName.compile,protocol_2.CompileCmdEnum.Compile,{from:e,type:o,compilePath:t,packageType:r});if(i("compile","end",{distPath:a,error:s}),s)throw s;return{distPath:a}}))}startFileServer(e,t){const r=this.log.bind(this,"info","startFileServer");r("server","start",{port:t,filePath:e});const o=this.fileServer.app=(0,express_1.default)();o.use(express_1.default.static(e)),this.fileServer.port=t,this.fileServer.server=o.listen(t),r("server","end",{})}sendMsgToClient(e){var t;null===(t=this.wsClient.client)||void 0===t||t.send(JSON.stringify(e))}handleClientMsg(e,t){this.log.bind(this,"info","handleClientMsg")("client","message",e.toString());const r=JSON.parse(e.toString());switch(r.event){case"init":const{version:e,type:o}=r.data;if("performance_analysis"!==o)return this.close(),this.emit(performance_1.EventEnum.PerformanceError,{error:["connect type error"]});if("1.0.0"!==e&&"1"!==e)return this.close(),this.emit(performance_1.EventEnum.PerformanceVersionInvalid,{});this.wsClient.connected=!0,this.emit(performance_1.EventEnum.PerformanceRunning,{});break;case"close":const{message:i,code:a}=r;"200"!==a&&(this.close(),this.emit(performance_1.EventEnum.PerformanceError,{error:[i||"unknown client error"]}));break;case"sendPerformanceData":const{total:s,index:n,data:l}=r.data;this.msgBuffer.client.push(l),n===s-1&&(this.emit(performance_1.EventEnum.PerformanceEnd,{data:{name:`${t}_${(0,utils_1.getFullDateNumbers)()}`,data:this.msgBuffer.client}}),this.sendMsgToClient({event:"close",data:{from:"server"},code:"200",message:""}),this.execute(protocol_1.ModuleName.eventTracker,protocol_2.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.app,{module:"devtools",click_type:"performance_end"}));break;default:this.wsClient.connected||(this.emit(performance_1.EventEnum.PerformanceVersionInvalid,{}),this.close())}}startSocket(e,t){const r=this.log.bind(this,"info","startSocket");r("server","start",{port:e}),this.wsServer.port=e;const o=this.wsServer.server=new ws_1.default.Server({port:e});o.on("connection",e=>{this.emit(performance_1.EventEnum.PerformanceConnecting,{}),this.wsClient.client=e,this.sendMsgToClient({event:"init",data:{type:"performance_analysis",version:"1",from:"server"}}),e.on("message",e=>this.handleClientMsg(e,t)),e.on("close",()=>{0===this.msgBuffer.client.length&&this.compilePath&&this.emit(performance_1.EventEnum.PerformanceClose,{}),this.close()})}),o.on("close",e=>{e&&r("server","close",{err:e})}),r("server","launched",{})}upload({appId:e,host:t,mode:r,compilePath:o,targetPath:i,platform:a,startPage:s,traceId:n}){return __awaiter(this,void 0,void 0,(function*(){const l=this.log.bind(this,"info","upload");l("info","start",{appId:e,host:t,mode:r,compilePath:o,targetPath:i,platform:a,startPage:s,traceId:n});const{enableWebviewSafeDomain:c=!0}=this.execute(protocol_1.ModuleName.storage,protocol_2.StorageCmdEnum.Get,o,"gadget","simulatorConfig"),p=a===upload_1.GadgetPlatform.Mobile?{wsForDebug:`ws://${t}:${this.wsServer.port}?from=performance_analysis`,debugPreviewType:preview_1.DebugPreviewType.DEBUG}:{wsForDebug:`ws://${t}:${this.wsServer.port}?from=performance_analysis`},m=this.fileServer.port,d=yield this.execute(protocol_1.ModuleName.preview,protocol_2.PreviewCmdEnum.pushDebugMsg,Object.assign({appId:e,serverUrl:`http://${t}:${m}`,targetPath:i,compilePath:o,fileServerPort:m,productName:a===upload_1.GadgetPlatform.Mobile?"app.ttpkg.js":"__dist__.zip",previewType:a===upload_1.GadgetPlatform.Mobile?preview_1.GadgetMobileMode.Mobile:r,previewPlatform:a,enableWebviewSafeDomain:c,startPage:s,traceId:n},p));return l("upload","end",{result:d}),qs_1.default.parse((d||"").split("?")[1])}))}close(){var e,t,r;const o=this.log.bind(this,"info","close");o("close","start",{});try{this.compilePath=void 0,null===(e=this.fileServer.server)||void 0===e||e.close(),this.fileServer={},null===(t=this.wsServer.server)||void 0===t||t.close(),this.wsServer={},this.wsClient&&(null===(r=this.wsClient.client)||void 0===r||r.off("close",()=>{}),this.wsClient={client:void 0,connected:!1}),this.msgBuffer={server:[],client:[]},o("close","end")}catch(e){o("close","end",{error:e})}}[performance_1.CmdEnum.Start](e){return __awaiter(this,void 0,void 0,(function*(){this.execute(protocol_1.ModuleName.eventTracker,protocol_2.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.app,{module:"devtools",click_type:"performance_start"});const t=this.log.bind(this,"info",performance_1.CmdEnum.Start);t("params","info",e);const r=e.platform===upload_1.GadgetPlatform.PC;try{this.close(),this.compilePath=e.compilePath;const{appId:o}=yield Upload_1.default.readProjectConfig(e.compilePath);if(!o)throw Error("AppId can not be empty, please check your project.");this.emit(performance_1.EventEnum.PerformanceInit,{platform:e.platform});const i=r?"127.0.0.1":(0,utils_1.getInternalIp)(!1),{distPath:a}=yield this.compile({compilePath:e.compilePath,from:"debug",packageType:r?"ZIP":"PKG",platform:e.platform}),s=yield(0,port_1.getFreePort)(9100);this.startFileServer(a,s);const n=yield(0,port_1.getFreePort)(9200);this.startSocket(n,o);const{token:l}=yield this.upload({appId:o,host:i,mode:e.mode,platform:e.platform,compilePath:e.compilePath,targetPath:a,traceId:e.traceId,startPage:e.startPage});if(e.platform===upload_1.GadgetPlatform.Mobile){const{enableWebviewSafeDomain:r=!0}=this.execute(protocol_1.ModuleName.storage,protocol_2.StorageCmdEnum.Get,e.compilePath,"gadget","simulatorConfig"),a={token:l,app_id:o,version:"v2",version_type:"preview",isdev:1,useCache:0,ide_disable_domain_check:r?0:1,start_page:e.startPage,scene:1015};t("debugMobile","start",{debugParamsMobile:a});const s="sslocal://microapp?"+qs_1.default.stringify(a);this.emit(performance_1.EventEnum.PerformanceWaiting,{mobileDebugUrl:s,host:i,platform:e.platform})}else this.emit(performance_1.EventEnum.PerformanceWaiting,{platform:e.platform})}catch(t){this.close(),this.emit(performance_1.EventEnum.PerformanceError,{platform:e.platform,error:[t.toString()]})}}))}[performance_1.CmdEnum.Stop](){const e=this.log.bind(this,"info",performance_1.CmdEnum.Stop);this.execute(protocol_1.ModuleName.eventTracker,protocol_2.EventTrackerCmdEnum.PerformanceTrackV2,eventTrackDef_1.EventTrack.app,{module:"devtools",click_type:"performance_stop"}),e("stop","start"),this.sendMsgToClient({event:"stop"})}}exports.default=PerformanceModule;