"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const flow_1=__importDefault(require("../../common/flow")),Module_1=__importDefault(require("../../common/Module")),get_1=require("./help/get"),init_1=require("./help/init"),set_1=require("./help/set"),storage_1=require("../../protocol/storage"),protocol_1=require("../../types/protocol"),protocol_2=require("../../protocol");class BaseStorageModule extends Module_1.default{constructor(){super(protocol_1.ModuleName.storage)}init(){this.data=(0,init_1.init)(this)}registerEvents(){}[storage_1.CmdEnum.Set](t,e,o,r){let s;const i=void 0!==r,a=i?e:"gadget";if(void 0!==o){const n=i?o:e,u=i?r:o;s=flow_1.default.runWithContext(this,a,"setProjectData",t,n,u,this.data)}else s=(0,set_1.setRoot)(t,e,this.data,this,a);this.emit(storage_1.EventEnum.StorageChange,s)}[storage_1.CmdEnum.Get](t,e,o){if(e){const r=o?e:"gadget",s=o||e;return flow_1.default.run(r,"getProjectData",t,s,this.data)}return this.data[t]}[storage_1.CmdEnum.GetUserConfig](t){var e;return(null===(e=this["Storage.Get"]("usersConfig"))||void 0===e?void 0:e[t])||{}}[storage_1.CmdEnum.GetFromDisk](t){var e;return null!==(e=this.get(t))&&void 0!==e?e:""}[storage_1.CmdEnum.SetUserConfig](t,e){const o=this["Storage.Get"]("usersConfig")||{},r=o[t],s=Object.assign(Object.assign({},r),e),i=Object.assign(Object.assign({},o),{[t]:s});this["Storage.Set"]("usersConfig",i)}[storage_1.CmdEnum.InitProject](t,e){const{environment:o}=this.execute(protocol_1.ModuleName.service,protocol_2.ServiceCmdEnum.GetEnvironment),r=e||"gadget";return flow_1.default.run(r,"initProjectData",t,this.data.rootPath,this.data,o).then(e=>((0,set_1.setProject)(t,e,this.data,this,r),(0,get_1.getProject)(t,this.data,r)))}[storage_1.CmdEnum.DeleteCompilePath](t,e){const o=flow_1.default.run(e,"getStorageKey","root"),r=this.get(o)||{},s=this.data[o]||{};return t.forEach(t=>{delete s[t],delete r[t]}),this.set(o,r),Promise.resolve(Object.keys(s))}}exports.default=BaseStorageModule;