"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ENV=void 0;const proxySchema_1=require("./proxySchema");function initSocket(e){const t="string"==typeof e?new WebSocket(e):e,o=[];return t.onopen=()=>{o.forEach(e=>{t.send(JSON.stringify(e))}),o.length=0},t.addEventListener("close",()=>{o.length=0}),{postMessage(e){1===t.readyState?t.send(JSON.stringify(e)):o.push(e)},onmessage(e){t.onmessage=t=>{const{data:o}=t;return e(JSON.parse(o))}}}}function getCommunication(e){return e?initSocket(e):{postMessage:e=>window.parent.postMessage(e,"*")}}function logProxy(){for(const e in console)if("function"==typeof console[e]){const t=console[e];console[e]=function(...o){t(...o),window.parent.postMessage((0,proxySchema_1.sendConsole)(e,...o),"*")}}}function initVscodeIframe(e,t){e&&logProxy();let o,n=!1;if(window[proxySchema_1.IframeQuery])o=window[proxySchema_1.IframeQuery],delete window[proxySchema_1.IframeQuery];else{const{search:e=""}=window.location,t=e.slice(1).split("&");for(let e=0,n=t.length;e<n;e++){const n=t[e];if(0===n.indexOf(proxySchema_1.IframeQuery+"=")){const e=n.split("=")[1];try{o=JSON.parse(decodeURIComponent(e))}catch(e){}break}}}window.addEventListener("message",({data:e})=>{const t=(0,proxySchema_1.initCss)(e);t&&(document.querySelector("html").style=t)});const r=getCommunication(t);return()=>{if(n)throw console.log((new Error).stack),new Error("An instance of the VS Code API has already been acquired");return n=!0,Object.freeze(Object.assign(Object.assign({},r),{setState:e=>(o=e,window.parent.postMessage({command:proxySchema_1.StateKey,data:e},"*"),e),getState:()=>o}))}}function initWeb(e,t){document.querySelector("html").style=e;let o=!1,n=localStorage.getItem(proxySchema_1.StateKey);if(n)try{n=JSON.parse(n)}catch(e){}window.addEventListener("unbeforunload",()=>{localStorage.removeItem(proxySchema_1.StateKey)});const r=getCommunication(window.top===window?t:null);return()=>{if(o)throw new Error("An instance of the VS Code API has already been acquired");return o=!0,Object.freeze(Object.assign(Object.assign({},r),{setState:e=>(n=e,localStorage.setItem(proxySchema_1.StateKey,JSON.stringify(e)),e),getState:()=>n}))}}exports.ENV="function"==typeof acquireVsCodeApi?"vscode_webview":/\sCode\/\d/.test(window.navigator.userAgent)?"vscode_iframe":"web";const init=(e="",t=null)=>{"vscode_webview"!==exports.ENV&&(window.acquireVsCodeApi="vscode_iframe"===exports.ENV?initVscodeIframe("boolean"!=typeof e||e,t):initWeb("boolean"==typeof e?"":e,t||""))};exports.default=init;