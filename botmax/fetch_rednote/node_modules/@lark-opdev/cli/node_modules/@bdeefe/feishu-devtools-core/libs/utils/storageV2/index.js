"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),Logger_1=require("../../common/Logger"),common_1=require("../../config/common"),cipher_1=require("./cipher"),commonLogger=(0,Logger_1.logger)(),logger=commonLogger.info.bind(commonLogger,"StorageUtilsV2");class StorageUtilsV2{constructor(t){if(StorageUtilsV2.instance)throw new Error("StoreUtils can only have one instance");StorageUtilsV2.instance=this,this.cipher=new cipher_1.Cipher(t.cipherConfig),this.refreshPath()}get(t){const e=fs_extra_1.default.readJSONSync(this.file);return JSON.parse(this.cipher.decrypt(e))[t]}set(t,e){const r=fs_extra_1.default.readJSONSync(this.file),a=JSON.parse(this.cipher.decrypt(r));void 0===e?delete a[t]:a[t]=e,fs_extra_1.default.writeJSONSync(this.file,this.cipher.encrypt(JSON.stringify(a)))}getRootPath(){return this.rootPath}refreshPath(){if(this.rootPath=common_1.configManager.config.CacheRoot,this.file=path_1.default.join(this.rootPath,common_1.configManager.config.storageFileV2),logger("refreshPath","start",this.rootPath,this.file),this.transformLegacyData(),fs_extra_1.default.ensureDirSync(this.rootPath),fs_extra_1.default.existsSync(this.file))try{fs_extra_1.default.readJSONSync(this.file)}catch(t){fs_extra_1.default.writeJSONSync(this.file,{})}else fs_extra_1.default.writeJSONSync(this.file,{})}transformLegacyData(){const t=path_1.default.join(this.rootPath,common_1.configManager.config.storageFile),e=path_1.default.join(this.rootPath,common_1.configManager.config.storageFileV2),r=fs_extra_1.default.existsSync(t),a=fs_extra_1.default.existsSync(e);if(logger("transformLegacyData","start",t,e),r){if(!a){const e=fs_extra_1.default.readJSONSync(t),r=this.cipher.encrypt(JSON.stringify(e));fs_extra_1.default.writeJSONSync(this.file,r),logger("transformLegacyData","convert ok")}fs_extra_1.default.removeSync(t)}else logger("transformLegacyData","skip")}}exports.default=StorageUtilsV2;