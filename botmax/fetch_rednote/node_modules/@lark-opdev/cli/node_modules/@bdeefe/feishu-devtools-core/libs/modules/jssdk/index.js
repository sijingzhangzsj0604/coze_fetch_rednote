"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(r,s){function n(e){try{a(i.next(e))}catch(e){s(e)}}function d(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(n,d)}a((i=i.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),node_1=__importDefault(require("@lark-opdev/i18n/libs/node")),Error_1=__importStar(require("../../common/Error")),Module_1=__importDefault(require("../../common/Module")),flow_1=__importDefault(require("../../common/flow")),common_1=require("../../config/common"),sdk_1=require("../../modules/static/item/sdk"),protocol_1=require("../../protocol"),jssdk_1=require("../../protocol/jssdk"),protocol_2=require("../../types/protocol"),utils_1=require("./help/utils");class JSSDKModule extends Module_1.default{constructor(){super(protocol_2.ModuleName.jssdk),this.curVersion="",this.compilePath=""}get sdkRootPath(){return this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"ideConfig").sdkRootPath}downloadDebuggerJSSDK(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info","downloadDebugger");t("downloadDebugger","start",{info:e});const{url:o,version:i}=e,r=i+".jssdk.zip",s=path_1.default.join(this.sdkRootPath,""+i,"__dev__");if(fs_extra_1.default.existsSync(s))return t("downloadDebugger","end",{msg:"使用 jssdk 缓存"}),{path:s};const n=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"),d=path_1.default.join(n,common_1.configManager.config.downloadTemp);return t("downloadDebuggerZipFile","start",{downloadTempPath:d}),yield(0,utils_1.downloadFile)(o,d,r),t("downloadDebuggerZipFile","end"),t("unzipDebugger","start",{downloadTempPath:d,zipName:r,jssdkPath:s}),yield(0,utils_1.unzip)(path_1.default.join(d,r),path_1.default.resolve(s,"../")),t("unzipDebugger","end"),{path:s}}))}getCurVersion(e,t){const o=this.log.bind(this,"info","getCurVersion");o("receiveParams","end",{compilePath:e,sdkList:t});const i=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,e,"simulatorConfig");o("getSimulatorConfig","end",{simulatorConfig:i});let r="";return i&&i.sdkVersion&&t.find(e=>e.version===i.sdkVersion)?r=i.sdkVersion:(null==t?void 0:t.length)>0?r=t[0].version:o("resolvedVersion","fail","no current version"),o("resolvedVersion","end",{curVersion:r}),r}updateSdkStorage(e,t){this.log.bind(this,"info","updateSdkStorage")("receiveParams","end",{appType:e,data:t});const o=flow_1.default.run(e,"getStorageKey","config"),i=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"ideConfig");this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Set,"ideConfig",Object.assign(Object.assign({},i),{[o]:Object.assign(Object.assign({},i[o]),t)}))}updateCurrentStorage(e,t){this.log.bind(this,"info","updateCurrentStorage")("receiveParams","end",{compilePath:e,version:t});const o=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,e,"simulatorConfig");this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Set,e,"simulatorConfig",Object.assign(Object.assign({},o),{sdkVersion:t}))}checkSdkExist(e,t,o){return __awaiter(this,void 0,void 0,(function*(){const i=this.log.bind(this,"info","checkSdkDownload");i("receiveParams","end",{appType:e,curVersion:t,sdkList:o});const r=o.find(({version:e})=>e===t);if(!r)throw new Error_1.default({code:Error_1.CoreErrorCode.LAUNCH_FAIL,message:node_1.default.t("SDK_VERSION_NOT_FOUND",{version:t})});yield this.execute(protocol_2.ModuleName.static,protocol_1.StaticCmdEnum.AddItem,new sdk_1.JSSDKItem(r.type,r.url,t.split(".").slice(0,3).join("."),t,r.larkVersion)),this.emit(jssdk_1.EventEnum.Finish,{path:path_1.default.join(this.sdkRootPath,t),version:t}),i("checkSDKExist","end")}))}[jssdk_1.CmdEnum.Init](e,t){return __awaiter(this,void 0,void 0,(function*(){const o=this.log.bind(this,"info",jssdk_1.CmdEnum.Init);o("receiveParams","end",{appType:e,compilePath:t}),this.compilePath=t;const i=yield this[jssdk_1.CmdEnum.GetSdkList](e);o("getSdkList","end",{sdkList:i});const r=i[0];return this.curVersion=this.getCurVersion(t,i),yield this.checkSdkExist(e,this.curVersion,i),this.updateCurrentStorage(this.compilePath,this.curVersion),this.updateSdkStorage(e,{sdkVersion:r.version,sdkList:i}),this.curVersion}))}[jssdk_1.CmdEnum.Update](e,t,o){return __awaiter(this,void 0,void 0,(function*(){const i=yield this[jssdk_1.CmdEnum.GetSdkList](e);yield this.checkSdkExist(e,o,i),this.curVersion=o,this.updateCurrentStorage(t,o)}))}[jssdk_1.CmdEnum.ResolveSDKPath](e,t){return path_1.default.join(this.sdkRootPath,e,"__dev__")}[jssdk_1.CmdEnum.DownloadDebuggerJSSDK](e,t){const o=t.match(/.*\/(.*).zip/i),i=o&&o[1]||"debugger";return this.downloadDebuggerJSSDK({url:t,version:i})}[jssdk_1.CmdEnum.GetSdkList](e){return flow_1.default.runWithContext(this,e,"fetchSdkList")}[jssdk_1.CmdEnum.GetPreloadPath](){return""}}exports.default=JSSDKModule;