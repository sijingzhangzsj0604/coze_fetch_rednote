"use strict";var __awaiter=this&&this.__awaiter||function(e,t,a,i){return new(a||(a=Promise))((function(o,s){function r(e){try{c(i.next(e))}catch(e){s(e)}}function n(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,n)}c((i=i.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.TemplateDefault=exports.TemplateItem=exports.JSSDKDefault=exports.JSSDKItem=exports.staticUpdate=void 0;const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),Module_1=__importDefault(require("../../common/Module")),common_1=require("../../config/common"),protocol_1=require("../../protocol"),static_1=require("../../protocol/static"),protocol_2=require("../../types/protocol"),functional_1=require("../../utils/functional"),utils_1=require("../../utils/utils"),utils_2=require("../jssdk/help/utils"),restore_1=require("./item/restore");var staticUpdate_1=require("./staticUpdate");Object.defineProperty(exports,"staticUpdate",{enumerable:!0,get:function(){return staticUpdate_1.staticUpdate}});var sdk_1=require("./item/sdk");Object.defineProperty(exports,"JSSDKItem",{enumerable:!0,get:function(){return sdk_1.JSSDKItem}}),Object.defineProperty(exports,"JSSDKDefault",{enumerable:!0,get:function(){return sdk_1.JSSDKDefault}});var template_1=require("./item/template");Object.defineProperty(exports,"TemplateItem",{enumerable:!0,get:function(){return template_1.TemplateItem}}),Object.defineProperty(exports,"TemplateDefault",{enumerable:!0,get:function(){return template_1.TemplateDefault}});class LockPool{constructor(){this.lockPool=new Set,this.eventMap=[]}get lockCount(){return this.lockPool.size}lock(e){this.lockPool.add(e)}unlock(e){this.lockPool.delete(e),0===this.lockPool.size&&this.eventMap.slice().map(e=>e())}hasLock(e){return this.lockPool.has(e)}addListener(e){this.eventMap.push(e)}}class StaticModule extends Module_1.default{constructor(){super(protocol_2.ModuleName.static),this.globalPath="",this.staticPath="",this.staticStorage=new Map,this.lockPool=new LockPool,this.backupToDisk=(0,functional_1.debounce)(()=>{const e=this.log.bind(this,"info","backupToDisk");e("backup","begin");const t=path_1.default.join(this.globalPath,common_1.configManager.config.staticFile);e("staticPath","is",{staticPath:t});const a={};for(const e of this.staticStorage.values()){const{name:t}=e;a[t]=e}e("data","is",{data:a}),fs_extra_1.default.writeJSONSync(t,a,{encoding:"utf-8"}),e("backup","success")},1e3),this.staticPath=common_1.configManager.config.downloadTemp}created(){super.created(),this.globalPath=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"),this.init()}[static_1.CmdEnum.AddItem](e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info",static_1.CmdEnum.AddItem);if(t("receiveParams","end",{item:e}),this.lockPool.hasLock(e.name))return void t("lock return","end",{name:e.name});const a=path_1.default.join(this.globalPath,this.staticPath,e.targetRelPath),i=path_1.default.join(this.globalPath,this.staticPath);t("targetPath","is",{targetPath:a,zipPath:i}),fs_extra_1.default.ensureDirSync(a),fs_extra_1.default.ensureDirSync(i);const o=fs_extra_1.default.readdirSync(a);t("readDir","end",{dirs:o});const s=this.staticStorage.get(e.name);t("curItem get","end",{curItem:s});const r=e=>__awaiter(this,void 0,void 0,(function*(){var o,s,r;t("itemUpdate","begin"),this.lockPool.lock(e.name);try{yield this.update(i,a,e),t("itemUpdate","success",{name:e.name}),this.staticStorage.set(e.name,{type:e.type,uri:e.uri,name:e.name,version:e.version,resourceType:e.resourceType,targetRelPath:e.targetRelPath,resourceName:e.resourceName,delPath:e.delPath,subType:null!==(o=e.subType)&&void 0!==o?o:"",unzipName:e.unzipName,meta:null!==(r=null===(s=e.getMeta)||void 0===s?void 0:s.call(e,path_1.default.join(a,e.resourceName)))&&void 0!==r?r:{}}),this.backupToDisk()}catch(e){return t("itemUpdate","fail",e),"fail"}finally{this.lockPool.unlock(e.name),t("itemUpdate","end",{name:e.name})}return"success"}));if(s)if((0,functional_1.versionCompare)(s.version,e.version)<0){t("itemUpdate","use","new",{item:e});if("success"===(yield r(e))){const e=path_1.default.join(this.globalPath,this.staticPath,s.targetRelPath,s.resourceName,s.delPath);t("oldItem remove","begin",{curItem:s,delPath:e}),fs_extra_1.default.remove(e,e=>{e?t("oldItem delete","failed",{targetPath:a,folder:s.resourceName,err:e}):t("oldItem delete","success",{targetPath:a,folder:s.resourceName})})}t("itemUpdate","new","end",{item:e})}else o.includes(s.resourceName)||(t("item","restore","old",{curItem:s}),yield r((0,restore_1.restoreItem)(s)),t("item","restore","end",{curItem:s}));else t("noItem","use","new",{item:e}),yield r(e),t("noItem","update","end",{item:e})}))}[static_1.CmdEnum.GetItem](e,t=1/0){const a=this.log.bind(this,"info",static_1.CmdEnum.GetItem);a("getItem","begin",{filterCount:t});const i=[...this.staticStorage.values()].filter(e).slice(0,t);return a("filtered","items",{filterItems:i}),this.lockPool.lockCount?new Promise(i=>{this.lockPool.addListener(()=>{a("lockPool","unlocked"),i([...this.staticStorage.values()].filter(e).slice(0,t))})}):(a("return","directly"),Promise.resolve(i))}[static_1.CmdEnum.GetStaticPath](){return this.staticPath}[static_1.CmdEnum.RemoveItem](e){const t=this.log.bind(this,"info",static_1.CmdEnum.RemoveItem);t("remove","begin",{item:e}),this.staticStorage.delete(e.name);const a=path_1.default.join(this.globalPath,this.staticPath,e.targetRelPath);t("remove","path",{zipPath:path_1.default.join(this.globalPath,this.staticPath),targetPath:a,itemName:e.resourceName}),fs_extra_1.default.removeSync(path_1.default.join(a,e.targetRelPath)),t("remove","success")}init(){const e=this.log.bind(this,"info","init"),t=path_1.default.join(this.globalPath,common_1.configManager.config.staticFile);if(fs_extra_1.default.existsSync(t)){e("diskFile","exist",{staticPath:t});try{const a=fs_extra_1.default.readJSONSync(t,{encoding:"utf-8"});e("readFile","success",{staticJSON:a});const i={};Object.keys(a).forEach(t=>{const{targetRelPath:o,resourceName:s}=a[t],r=path_1.default.join(this.globalPath,this.staticPath,o,s);e("process","item",{name:t,itemPath:r}),fs_extra_1.default.existsSync(r)&&(e("item exist","try restore"),Object.assign(i,{[t]:a[t]}),e("restore","data",{[t]:a[t]}),this.staticStorage.set(t,a[t]))}),e("begin","write json"),fs_extra_1.default.writeJSONSync(t,i,{encoding:"utf-8"}),e("write","success")}catch(e){this.log("error","init","end","fail",{error:e})}}}update(e,t,a){return __awaiter(this,void 0,void 0,(function*(){const i=this.log.bind(this,"info","update");i("receiveParams","end",{targetPath:t,zipPath:e});const o=path_1.default.join(t,a.resourceName);i("itemPath","is",{itemPath:o}),fs_extra_1.default.existsSync(o)?i("update","end","cache hit"):("remote"===a.type?(i("remote","update",{uri:a.uri,zipPath:e}),yield(0,utils_2.downloadFile)(a.uri,e,a.name+".zip"),i("download","success",{uri:a.uri,zipPath:e})):(i("local","update",{uri:a.uri,zipPath:e}),yield fs_extra_1.default.copyFile(a.uri,path_1.default.join(e,a.name+".zip")),i("local","success",{uri:a.uri,zipPath:e})),i("unzipFile","begin",{name:a.name+".zip"}),yield(0,utils_1.unzipFile)(path_1.default.join(e,a.name+".zip"),t),i("unzipFile","end",{name:a.name+".zip"}),a.resourceName!==a.unzipName&&(i("renameDir","begin",{name:a.name+".zip",itemPath:o}),yield(0,utils_1.renameSafe)(path_1.default.join(t,a.unzipName),o),i("renameDir","success",{name:a.name+".zip",itemPath:o})),a.finish.call(this,o),fs_extra_1.default.removeSync(path_1.default.join(e,a.name+".zip")),i("removeDir","success",{name:a.name+".zip"}))}))}}exports.default=StaticModule;