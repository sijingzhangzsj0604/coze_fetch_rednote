"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function i(e){try{g(o.next(e))}catch(e){a(e)}}function s(e){try{g(o.throw(e))}catch(e){a(e)}}function g(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,s)}g((o=o.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),Logger_1=require("../../common/Logger"),common_1=require("../../config/common"),env_1=__importDefault(require("../../config/env")),environment_1=require("../../config/environment"),Request_1=__importDefault(require("../../modules/service/help/Request")),static_1=require("../../modules/static"),protocol_1=require("../../protocol"),storage_1=require("../storage");class Update{constructor(){this.request=new Request_1.default({})}getTenantUserId(){return __awaiter(this,void 0,void 0,(function*(){try{const e=(0,storage_1.getStorageIns)().get("accountInfo");if(e)return{userId:e.user.id,tenantId:e.tenant.id,environment:e.env}}catch(e){}return{userId:"",tenantId:"",environment:""}}))}getStorageProxy(){(0,Logger_1.logger)().info("getStorageProxy","get","start");const e={type:"direct",proxy:{}};try{const t=(0,storage_1.getStorageIns)().get("settings");return"object"==typeof(null==t?void 0:t.proxy)?Object.assign(Object.assign({},e),t.proxy):((0,Logger_1.logger)().info("getStorageProxy","composition","fail"),e)}catch(t){return(0,Logger_1.logger)().error("getStorageProxy","get","error",t.toString()),e}}getUpdateUrl(e){var t;return __awaiter(this,void 0,void 0,(function*(){const{environment:r,userId:o,tenantId:n}=yield this.getTenantUserId();let a;a=env_1.default.private?env_1.default.environments[0].internalAPI:r?null===(t=(0,environment_1.getEnvironmentConfig)(r))||void 0===t?void 0:t.internalAPI:env_1.default.environments[0].internalAPI;return`https://${a}/settings/v3?app_id=1161&version=${e}&app_channel=${env_1.default.name}&user_id=${o}&tenant_id=${n}`}))}getFGUrl(e){var t;return __awaiter(this,void 0,void 0,(function*(){const{userId:r,environment:o}=yield this.getTenantUserId();let n;return n=env_1.default.private?env_1.default.environments[0].internalAPI:o?null===(t=(0,environment_1.getEnvironmentConfig)(o))||void 0===t?void 0:t.internalAPI:env_1.default.environments[0].internalAPI,`https://${n}/settings/fg?version=${e}&platform=iphone&user_id=${r||""}&fg_app=Feishu`}))}fetchUpdateData(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield this.getUpdateUrl(e);(0,Logger_1.logger)().info("fetchUpdateData","getUpdateUrl","end",{url:t});const r=this.getStorageProxy(),o=yield this.request.fetch(t,{method:"get",proxy:r});if(o.opdev_ide){return o.opdev_ide}return(0,Logger_1.logger)().error("fetchUpdateData","configNotFound","end",{data:o.opdev_ide}),null}))}writeUpdateData(e,t=!0){return __awaiter(this,void 0,void 0,(function*(){const r=path_1.default.join(common_1.configManager.config.CacheRoot,common_1.configManager.config.updateFile),o=common_1.configManager.config.version;try{const n=yield this.fetchUpdateData(o);if(n){const a=n;return yield fs_extra_1.default.ensureDir(common_1.configManager.config.CacheRoot),yield fs_extra_1.default.outputJson(r,{data:a,time:Date.now(),version:o}),t&&e&&this.updateStaticResource(e),a}}catch(e){(0,Logger_1.logger)().error("writeUpdateData","requestUpdateData","error",e.toString())}return null}))}getFGData(){const e=path_1.default.join(common_1.configManager.config.CacheRoot,common_1.configManager.config.fgFile);(0,Logger_1.logger)().info("getFGData","getFgPath","success",{fgPath:e});try{const t=fs_extra_1.default.readJSONSync(e);return(0,Logger_1.logger)().info("getFGData","readJSONSync","success"),t}catch(e){return(0,Logger_1.logger)().error("getFGData","readJSONSync","error",{error:e}),{data:{features:[]},time:Date.now(),version:common_1.configManager.config.version}}}getUpdateData(){const e=path_1.default.join(common_1.configManager.config.CacheRoot,common_1.configManager.config.updateFile);try{return fs_extra_1.default.readJSONSync(e).data}catch(e){return(0,Logger_1.logger)().error("getUpdateData","readJSONSync","error",{error:e}),{block:{isBlocked:!1,reason:""},update:{ideNeedUpdate:!1,ideUpdateUrl:"",ideReleaseNotes:"",ideVersion:""},jssdk:{},cli:{installCmd:"",uninstallCmd:"",needUpdate:!1,forceUpdate:!1,updateReason:"",latestVersion:"",templateMeta:{list:[]}}}}}writeFGData(){return __awaiter(this,void 0,void 0,(function*(){const e=path_1.default.join(common_1.configManager.config.CacheRoot,common_1.configManager.config.fgFile),t=common_1.configManager.config.version;try{const r=yield this.getFGUrl(t);(0,Logger_1.logger)().info("writeFGData","getFGUrl","end",{url:r});const o=this.getStorageProxy(),n=yield this.request.fetch(r,{method:"get",proxy:o});if(n&&n.features){yield fs_extra_1.default.ensureDir(common_1.configManager.config.CacheRoot);const r={data:n,time:Date.now(),version:t};return yield fs_extra_1.default.outputJson(e,r),n}}catch(e){(0,Logger_1.logger)().error("writeFGData","requestFGData","error",e.toString())}}))}updateStaticResource(e){try{const{data:t}=fs_extra_1.default.readJSONSync(path_1.default.join(e.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"),common_1.configManager.config.updateFile)),{templates:r,jssdk:o}=t,n={};Object.keys(r).forEach(e=>{var t;n[e]=[];const o=null!==(t=r[e])&&void 0!==t?t:[];for(let t=0;t<o.length;++t)"gadget-plugin"!==o[t].name?n[e].push(new static_1.TemplateItem("remote",o[t].url,o[t].name,o[t].version,e)):n.gadget_plugin=[new static_1.TemplateItem("remote",o[t].url,o[t].name,o[t].version,"gadget","plugin")]}),n.jssdk=[],Object.keys(o).forEach(e=>{const t=o[e],r=t.jssdkVersion.split(".").slice(0,3).join(".");n.jssdk.push(new static_1.JSSDKItem("remote",t.url,r,t.jssdkVersion,e))}),(0,static_1.staticUpdate)(e.execute,n)}catch(e){console.log("[update] error",e.toString())}}}exports.default=Update;