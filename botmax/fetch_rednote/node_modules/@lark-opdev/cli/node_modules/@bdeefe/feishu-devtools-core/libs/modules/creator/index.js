"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,a)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(a,n){function i(e){try{c(r.next(e))}catch(e){n(e)}}function u(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(i,u)}c((r=r.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const fs_extra_1=__importDefault(require("fs-extra")),glob_1=__importDefault(require("glob")),path_1=__importDefault(require("path")),Error_1=__importStar(require("../../common/Error")),Module_1=__importDefault(require("../../common/Module")),api_1=require("../../config/api"),common_1=require("../../config/common"),protocol_1=require("../../protocol"),creator_1=require("../../protocol/creator"),ui_1=require("../../protocol/ui"),protocol_2=require("../../types/protocol"),lang_1=require("../../utils/lang"),static_1=require("../static"),template_1=require("../static/item/template"),generator_1=require("./generator");class CreatorModule extends Module_1.default{constructor(){super(protocol_2.ModuleName.creator),this.localPath=""}[creator_1.CmdEnum.list](e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info",creator_1.CmdEnum.list);t("receiveParams","end",{options:e});const{appType:o}=e,r={resourceType:o};"gadget"!==o||(0,common_1.featureGating)(common_1.FeatureGatingKeys.enableGadgetPlugin)||Object.assign(r,{subType:""});try{const e=yield this.execute(protocol_2.ModuleName.static,protocol_1.StaticCmdEnum.GetItem,e=>Object.keys(r).every(t=>e[t]===r[t]));return e.sort((e,t)=>{if(e.subType===t.subType){if(template_1.TemplateDefault[e.subType]){return template_1.TemplateDefault[e.subType].findIndex(t=>t.name===e.name)-template_1.TemplateDefault[e.subType].findIndex(e=>e.name===t.name)}return template_1.TemplateDefault[e.resourceType].findIndex(t=>t.name===e.name)-template_1.TemplateDefault[e.resourceType].findIndex(e=>e.name===t.name)}return e.subType<t.subType?-1:1}),yield Promise.all(e.map(e=>this.execute(protocol_2.ModuleName.static,protocol_1.StaticCmdEnum.AddItem,new static_1.TemplateItem(e.type,e.uri,e.name,e.version,e.resourceType,e.subType)))),e}catch(e){throw t("list","end",{error:e}),new Error_1.default({code:Error_1.CoreErrorCode.CREATED_FAIL,message:e})}}))}[creator_1.CmdEnum.generate](e){return __awaiter(this,void 0,void 0,(function*(){const t=this.log.bind(this,"info",creator_1.CmdEnum.generate),{name:o,target:r,meta:a}=e;if(t("receiveParams","end",{name:o,target:r,meta:a}),fs_extra_1.default.existsSync(r)){if(!(yield this.execute(protocol_2.ModuleName.ui,protocol_1.UICmdEnum.confirm,{content:`Target directory exists(${path_1.default.basename(r)}). Continue?`})))return!1}fs_extra_1.default.ensureDirSync(r),this.localPath=path_1.default.join(this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"),"templates");try{t("copy","start",{localPath:this.localPath,name:o,target:r}),yield fs_extra_1.default.copy(path_1.default.join(this.localPath,o,"src"),r),t("copy","end")}catch(e){t("copy","end",{error:e}),console.log(e,"copy fail")}if(a){t("updateConfigFile","start",{meta:a});const e=path_1.default.join(r,"project.config.json"),o=fs_extra_1.default.readJSONSync(e),n=Object.assign(Object.assign({},o),{appid:a.appId,projectname:a.projectName});if(fs_extra_1.default.writeFileSync(e,JSON.stringify(n,null,2),"utf8"),t("updateConfigFile","end",{updatedConfig:n}),a.blockTypeId&&Array.isArray(o.blocks)&&o.blocks.forEach(e=>{const t=path_1.default.join(r,e+".json");if(fs_extra_1.default.existsSync(t)){const e=fs_extra_1.default.readJSONSync(t);e.blockTypeID=a.blockTypeId,fs_extra_1.default.writeFileSync(t,JSON.stringify(e,null,2),"utf8")}}),"plugin"===(null==o?void 0:o.compileType)){const e=path_1.default.join(r,o.miniprogramRoot);if(fs_extra_1.default.existsSync(e)){glob_1.default.sync("**/*.js",{cwd:e,nodir:!0}).forEach(t=>{const o=path_1.default.join(e,t),r=fs_extra_1.default.readFileSync(o).toString();fs_extra_1.default.writeFileSync(o,r.replace(/REPLACE_WITH_ACTUAL_PLUGIN_ID/gm,a.appId),"utf8")})}}}return!0}))}[creator_1.CmdEnum.generateV2](e){return __awaiter(this,void 0,void 0,(function*(){const t=!!process.env.DEBUG_TEMPLATES_ROOT,{templateCate:o,templateConfig:r,projectPath:a}=e,{name:n,version:i,url:u}=r,{hideLoading:c}=this.execute(protocol_2.ModuleName.ui,protocol_1.UICmdEnum.showLoading,{text:"downloading template..."}),l=new static_1.TemplateItem("remote",u,n,i,o.type);t&&this.execute(protocol_2.ModuleName.static,protocol_1.StaticCmdEnum.RemoveItem,l),yield this.execute(protocol_2.ModuleName.static,protocol_1.StaticCmdEnum.AddItem,l);const s=(yield this.execute(protocol_2.ModuleName.static,protocol_1.StaticCmdEnum.GetItem,e=>e.name===n))[0];if(c(),!s)throw new Error("template not found");const _=path_1.default.join(this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"),"templates"),d=path_1.default.join(_,s.resourceName),p=path_1.default.join(d,"src"),m=path_1.default.join(d,"generator.config.js"),f=path_1.default.resolve(a),h=path_1.default.join(common_1.configManager.config.CacheRoot,".unzip_temp",s.resourceName);fs_extra_1.default.existsSync(h)&&fs_extra_1.default.removeSync(h),yield fs_extra_1.default.copy(p,h);const y=require(m),g=this.execute(protocol_2.ModuleName.account,protocol_1.AccountCmdEnum.Info);if(!g)throw new Error("not login");const x=new generator_1.Generator({template:r,tempDir:h,projectPath:f,ui:ui_1.UIDesc.commandNames.reduce((e,t)=>(e[t]=(...e)=>this.execute(protocol_2.ModuleName.ui,t,...e),e),{}),plugins:y.plugins,lang:(0,lang_1.getSystemLang)(),execute:this.execute,environment:g.env,domain:(0,api_1.getDomain)(g.env)});yield x.run(),fs_extra_1.default.removeSync(h)}))}}exports.default=CreatorModule;