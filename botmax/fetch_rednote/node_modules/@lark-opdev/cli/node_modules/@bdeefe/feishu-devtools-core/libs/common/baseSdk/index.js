"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(a,i){function n(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(n,s)}c((r=r.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const child_process_1=__importDefault(require("child_process")),clipboardy_1=__importDefault(require("clipboardy")),fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),api_1=require("../../config/api"),common_1=require("../../config/common"),Upload_1=__importDefault(require("../../modules/upload/help/Upload")),protocol_1=require("../../protocol"),utils_1=require("../bridge/utils"),request_error_1=require("../request-error"),api_2=require("./api");class BaseSdk extends utils_1.AbstractSdk{constructor(e,t,o){super(),this.execute=e,this.addEventListener=t,this.compilePath=o}[api_2.TransferApi.checkProject](e){return __awaiter(this,void 0,void 0,(function*(){const{appType:t}=e;if("gadget"===t||"block"===t||"h5_in_block"===t)try{yield this.execute(protocol_1.ModuleName.simulator,protocol_1.SimulatorCmdEnum.checkProject,e.compilePath,t)}catch(e){throw new Error(e.message)}else if("h5"===t)return Promise.resolve()}))}[api_2.TransferApi.getSystemPathInfo](e){const t=process.env.HOME,o=e.path||t,r=fs_extra_1.default.existsSync(o);if(!r)return Promise.resolve({exist:r,currentPath:o});const a=fs_extra_1.default.statSync(o).isDirectory();if(!a)return Promise.resolve({exist:r,isDirectory:a,currentPath:o});const i=".".charCodeAt(0),n=fs_extra_1.default.readdirSync(o).filter(e=>e.charCodeAt(0)!==i).map(e=>{const t=path_1.default.join(o,e);return{name:e,path:t,isDirectory:fs_extra_1.default.existsSync(t)&&fs_extra_1.default.statSync(t).isDirectory()}});return Promise.resolve({exist:r,isDirectory:a,children:n,currentPath:o})}[api_2.TransferApi.getClipboardData](){const e=clipboardy_1.default.readSync();return Promise.resolve({data:e})}[api_2.TransferApi.openFile](e){return"Windows_NT"===os_1.default.type()?child_process_1.default.exec(`start "" "${e.dir}"`):child_process_1.default.exec(`open "${e.dir}"`),Promise.resolve({})}[api_2.TransferApi.accountInfo](){const e=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"accountInfo");if(e){const t={userName:e.user.name,displayName:e.user.displayName,i18nDisplayNames:e.user.i18nDisplayNames,i18nNames:e.user.i18nNames,userAvatar:e.user.avatar,tenantName:e.tenant.name,tenantI18nNames:e.tenant.i18nNames,tenantAvatar:e.tenant.avatar,tenantEnv:e.user.env};return Promise.resolve(t)}return Promise.resolve(void 0)}[api_2.TransferApi.fullAccountInfo](){return __awaiter(this,void 0,void 0,(function*(){return yield this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.Info)}))}[api_2.TransferApi.accountLogin](e){return new Promise((t,o)=>{this.addEventListener(protocol_1.ModuleName.account,protocol_1.AccountEventEnum.Logined,()=>{t({})}),this.addEventListener(protocol_1.ModuleName.account,protocol_1.AccountEventEnum.loginTimeout,()=>{o(Error("login timeout"))}),this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.Login,{showSuccessPage:!0,environment:e.environment,skipConfirm:!0})})}[api_2.TransferApi.accountLogout](){return new Promise(e=>{this.addEventListener(protocol_1.ModuleName.account,protocol_1.AccountEventEnum.Logouted,()=>{e({})}),this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.Logout,{skipConfirm:!0})})}[api_2.TransferApi.accountTenant](){return __awaiter(this,void 0,void 0,(function*(){const e=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"accountInfo"),t=yield this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.tenantList);if(t)return{tenantList:t.filter(({user:t})=>t.env===(null==e?void 0:e.user.env))}}))}[api_2.TransferApi.accountTenantSwitch](e){return new Promise(t=>{this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.switchTenant,e.account).then(e=>{"fail"===e.result?t({success:!1,msg:e.msg}):"success"===e.result&&t({success:!0,msg:e.msg})})})}[api_2.TransferApi.openPage](e){return this.execute(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.openPage,e.url),Promise.resolve({})}[api_2.TransferApi.recentProject](){return this.execute(protocol_1.ModuleName.compile,protocol_1.CompileCmdEnum.ListPath)}[api_2.TransferApi.deleteProjects](e){return this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.DeleteCompilePath,e.compilePaths,e.appType)}[api_2.TransferApi.templateList](e){return __awaiter(this,void 0,void 0,(function*(){return yield this.execute(protocol_1.ModuleName.creator,protocol_1.CreatorCmdEnum.list,e)}))}[api_2.TransferApi.createProject](e){return __awaiter(this,void 0,void 0,(function*(){const t=path_1.default.join(e.targetPath,e.projectName);return yield this.execute(protocol_1.ModuleName.creator,protocol_1.CreatorCmdEnum.generate,{name:e.templateName,target:t,meta:{appId:e.appID,projectName:e.projectName,blockTypeId:e.blockTypeId}}),t}))}[api_2.TransferApi.feedback](){const e=this.execute(protocol_1.ModuleName.feedback,protocol_1.FeedbackCmdEnum.Feedback);return Promise.resolve(e)}[api_2.TransferApi.helpDocUrl](){const e=this.execute(protocol_1.ModuleName.feedback,protocol_1.FeedbackCmdEnum.DocUrl);return Promise.resolve(e)}[api_2.TransferApi.getUUID](){const e=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"uuid")||"";return Promise.resolve({uuid:e})}[api_2.TransferApi.eventTracker](e){this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.Counter,e.name,e.tags||{})}[api_2.TransferApi.eventTrackV2](e){const{name:t,tags:o={},traceId:r,timingName:a}=e;this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrackV2,t,o,r,a)}[api_2.TransferApi.reportResult](e){const{name:t,result:o,tags:r,traceId:a}=e;this.execute(protocol_1.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.ResultReport,t,o,r,a)}[api_2.TransferApi.getSettings](){const e=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"settings")||{};return Promise.resolve({settings:e})}[api_2.TransferApi.setSettings](e){const t=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"settings")||{};this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Set,"settings",Object.assign(Object.assign({},t),e.settings))}[api_2.TransferApi.featureGating](e){return Promise.resolve((0,common_1.featureGating)(e.keys))}[api_2.TransferApi.getRoutePath](){return Promise.resolve(this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"rootPath"))}[api_2.TransferApi.getIDEStorage](e){const{key:t,compilePath:o}=e;if(o){const e=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,o,t);return Promise.resolve(e)}return Promise.resolve(this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,t))}[api_2.TransferApi.setStorage](e){const{key:t,value:o,compilePath:r}=e;return r?Promise.resolve(this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Set,r,t,o)):Promise.resolve(this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Set,t,o))}[api_2.TransferApi.updateSimulatorConfig](e){const{compilePath:t,config:o}=e,r=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,t,"simulatorConfig");return this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Set,t,"simulatorConfig",Object.assign(Object.assign({},r),o)),Promise.resolve()}[api_2.TransferApi.reportIssue](e){return this.execute(protocol_1.ModuleName.feedback,protocol_1.FeedbackCmdEnum.reportIssue,e)}[api_2.TransferApi.enableBlock](){return Promise.resolve((0,common_1.featureGatingBlock)())}[api_2.TransferApi.enableH5Block](){return Promise.resolve((0,common_1.featureGatingH5Block)())}[api_2.TransferApi.uploadH5Offline](e){return __awaiter(this,void 0,void 0,(function*(){try{return void(yield this.execute(protocol_1.ModuleName.upload,protocol_1.UploadCmdEnum.uploadH5Offline,e))}catch(e){throw new Error(e.message)}}))}[api_2.TransferApi.getH5OfflineMeta](e){return __awaiter(this,void 0,void 0,(function*(){return yield this.execute(protocol_1.ModuleName.upload,protocol_1.UploadCmdEnum.getH5OfflineMeta,e)}))}[api_2.TransferApi.getDebugTenantList](e){if(!this.compilePath)throw Error("Use function in wrong mode");const{applicationType:t="invalid",debugTenantList:o=[],debugAccountInfo:r}=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,this.compilePath,e.appType,"simulatorConfig"),a="store"===t?o.sort((e,t)=>(null==r?void 0:r.tenant.id)===e.tenant.id?-1:(null==r?void 0:r.tenant.id)===t.tenant.id?1:e.tenant.isLogin&&!t.tenant.isLogin?-1:!e.tenant.isLogin&&t.tenant.isLogin?1:0):o;return Promise.resolve({applicationType:t,debugTenantList:a})}[api_2.TransferApi.switchDebugTenant](e){if(!this.compilePath)throw Error("Use function in wrong mode");return this.execute(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.switchDebugTenant,e.account,this.compilePath,e.appType)}[api_2.TransferApi.getDebugAccount](e){if(!this.compilePath)throw Error("Use function in wrong mode");const{debugAccountInfo:t}=this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,this.compilePath,e.appType,"simulatorConfig");return Promise.resolve({debugAccount:t})}[api_2.TransferApi.detectCompileTask](e){return __awaiter(this,void 0,void 0,(function*(){const{appType:t,platform:o}=e,{appId:r}=yield Upload_1.default.prepareCheck(this.compilePath,"",this.execute);return this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.detectCompileTask,{appId:r,extension_type:Upload_1.default.getExtensionTypeByAppType(t,o)})}))}[api_2.TransferApi.cancelCompileTask](e){var t,o,r;return __awaiter(this,void 0,void 0,(function*(){const{version:a,appType:i,platform:n}=e,{appId:s}=yield Upload_1.default.prepareCheck(this.compilePath,"",this.execute),c=yield this.execute(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.cancelCompileTask,{version:a,appId:s,extension_type:Upload_1.default.getExtensionTypeByAppType(i,n)},{responseCode:!0,logId:!0});if(0===c.code)return c.data;throw new request_error_1.RequestError((null===(o=null===(t=c.error)||void 0===t?void 0:t.localizedMessage)||void 0===o?void 0:o.message)||(null===(r=c.error)||void 0===r?void 0:r.msg)||c.msg,c.code,c.logId)}))}[api_2.TransferApi.resume](e){return __awaiter(this,void 0,void 0,(function*(){const{appType:t,platform:o,blockTypeId:r,identifier:a}=e,{appId:i}=yield Upload_1.default.prepareCheck(this.compilePath,"",this.execute);return this.execute(protocol_1.ModuleName.upload,protocol_1.UploadCmdEnum.uploadResume,{appId:i,appType:t,platform:o,blockTypeId:r,identifier:a})}))}[api_2.TransferApi.resumeGadgetPreview](e){return __awaiter(this,void 0,void 0,(function*(){const{platform:t}=e,{appId:o}=yield Upload_1.default.prepareCheck(this.compilePath,"",this.execute),r=yield this.execute(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,this.compilePath,"simulatorConfig"),{compileModeConfig:a,enableWebviewSafeDomain:i}=r,n=a.list.find(e=>e.active);let s;if(n){const{entryPath:e,entryParam:t}=n;s=e+(t?"?"+t:"")}return this.execute(protocol_1.ModuleName.preview,protocol_1.PreviewCmdEnum.previewGadgetResume,{appId:o,platform:t,compilePath:this.compilePath,startPage:s,enableWebviewSafeDomain:i})}))}}exports.default=BaseSdk;