"use strict";var __rest=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventTrack=void 0;const Module_1=__importDefault(require("../../common/Module")),env_1=__importDefault(require("../../config/env")),protocol_1=require("../../protocol"),eventTracker_1=require("../../protocol/eventTracker"),protocol_2=require("../../types/protocol"),encrypt_1=__importDefault(require("../../utils/encrypt")),Request_1=__importDefault(require("../service/help/Request"));var eventTrackDef_1=require("./eventTrackDef");Object.defineProperty(exports,"EventTrack",{enumerable:!0,get:function(){return eventTrackDef_1.EventTrack}});class EventTracker extends Module_1.default{constructor(e){super(protocol_2.ModuleName.eventTracker),this.timingStore={},this.reportedOpen=!1,this.commonTags={},this.config=e,this.request=new Request_1.default({})}created(){this.config&&this[eventTracker_1.CmdEnum.Init]()}[eventTracker_1.CmdEnum.Init](){var e,t;const r=this.config;if(this.reportedOpen=r.isOpen,!this.reportedOpen)return;const n=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"uuid"),i=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,"accountInfo");let o="",s="";const a=(null===(e=null==i?void 0:i.user)||void 0===e?void 0:e.id)?(0,encrypt_1.default)(null===(t=null==i?void 0:i.user)||void 0===t?void 0:t.id):"",c=(null==i?void 0:i.env)||"";i&&(o=i.tenant.name?(0,encrypt_1.default)(i.tenant.name):"",s=i.tenant.id?(0,encrypt_1.default)(i.tenant.id):""),this.commonTags=Object.assign(Object.assign({},r.commonTags),{uuid:n,tenantName:o,tenantId:s,env:c,userId:a}),env_1.default.oversea||this.initSlardar({uuid:n}),this.initTea(this.commonTags)}teaCollect(e,t){var r;null===(r=this.teaSDK)||void 0===r||r.collect({name:e,event:t})}[eventTracker_1.CmdEnum.Track](e,t){this.teaCollect(e,t)}[eventTracker_1.CmdEnum.Counter](e,t){this.commonSend({event_name:e,type:"counter",value:(null==t?void 0:t.value)||1,tags:Object.assign(Object.assign({},this.commonTags),null==t?void 0:t.tags)})}[eventTracker_1.CmdEnum.PerformanceTrack](e,t){const{error:r,duration:n}=t,i=__rest(t,["error","duration"])||{},{timeStart:o,timeEnd:s}=i,a=__rest(i,["timeStart","timeEnd"]);let c="";r&&(c=r.message);e.includes("_total")&&r&&this.reportError(r),this.commonSend({type:"timer",event_name:e,value:n,tags:Object.assign(Object.assign(Object.assign({},this.commonTags),a),{timeStart:String(o),timeEnd:String(s),error:c})})}[eventTracker_1.CmdEnum.Timer](e,t){const{tags:r,value:n}=t,i=r||{},{timeStart:o,timeEnd:s}=i,a=__rest(i,["timeStart","timeEnd"]);this.commonSend({type:"timer",event_name:e,value:n,tags:Object.assign(Object.assign(Object.assign({},this.commonTags),a),{timeStart:String(o),timeEnd:String(s)})})}[eventTracker_1.CmdEnum.Log](e){this.commonSend({type:"log",level:e.level||"info",value:e.value,tags:Object.assign(Object.assign({},this.commonTags),e.tags)})}[eventTracker_1.CmdEnum.PerformanceTrackV2](e,t={},r,n=""){var i;this.timingStore[e]||(this.timingStore[e]={});const{date:o=Date.now()}=t;if(r)if(this.timingStore[e][r])if(n){const{start:s,timings:a,tags:c}=this.timingStore[e][r];a[n]=null!==(i=a[n])&&void 0!==i?i:Math.max(Number(o)-s,0),this.timingStore[e][r].tags=Object.assign(Object.assign({},c),t)}else console.error(new Error(`The timingStore of ${e} is created , but PerformanceTrackV2 doesn't receive timingName. tags: ${t}, traceId: ${r}`));else n&&"start"!==n&&console.error(new Error(`The timingStore of ${e} is not created , but PerformanceTrackV2 receive timingName: ${n}. tags: ${JSON.stringify(t)}, traceId: ${r}`)),this.timingStore[e][r]={start:Number(o),tags:t,timings:{}};n||this.teaCollect(e,Object.assign({trace_id:r},t))}[eventTracker_1.CmdEnum.ResultReport](e,t,r={},n){var i,o;const s=n&&null!==(o=null===(i=this.timingStore[e][n])||void 0===i?void 0:i.tags)&&void 0!==o?o:{};if(this.teaCollect(e+"_result",Object.assign(Object.assign(Object.assign({},s),r),{trace_id:n,result:t})),n){const{timings:t,tags:r,start:i}=this.timingStore[e][n];t.end||(t.end=Date.now()-i),t.end=Math.max(0,t.end),this.teaCollect(e+"_timing",Object.assign(Object.assign({trace_id:n},r),{start:i,timings:JSON.stringify(t)})),delete this.timingStore[e][n]}}}exports.default=EventTracker;