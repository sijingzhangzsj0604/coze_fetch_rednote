"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(i,a){function s(e){try{n(r.next(e))}catch(e){a(e)}}function c(e){try{n(r.throw(e))}catch(e){a(e)}}function n(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}n((r=r.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const cors_1=__importDefault(require("cors")),express_1=__importDefault(require("express")),express_sse_1=__importDefault(require("express-sse")),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),Error_1=__importStar(require("../../../common/Error")),api_1=require("../../../config/api"),common_1=require("../../../config/common"),protocol_1=require("../../../protocol"),protocol_2=require("../../../types/protocol"),timer_1=__importDefault(require("../../../utils/timer")),BlockBase_1=__importDefault(require("./BlockBase")),Encrypt_1=__importDefault(require("./Encrypt")),Upload_1=__importDefault(require("./Upload")),defaultIcon="data:image/png;base64,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";class Block extends BlockBase_1.default{constructor(e){super({execute:e.execute}),this.extensionPath=path_1.default.join(__dirname,"..","..","..","pages","extensions","block"),this.projectConfigFileName="project.config.json",this.useNewCompiler=!1,this.projectPath=e.projectPath,this.watch=Boolean(e.watch)}setWatch(e){this.watch=e}useNewCompilerOnNextRequest(){this.useNewCompiler=!0}compile(e){return __awaiter(this,void 0,void 0,(function*(){if(!this.readBlockConfig(e))return"";let t=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,this.projectPath,"block","tmpConfig");t||(yield this.execute(protocol_2.ModuleName.compile,protocol_1.CompileCmdEnum.SetPath,this.projectPath),t=this.execute(protocol_2.ModuleName.storage,protocol_1.StorageCmdEnum.Get,this.projectPath,"block","tmpConfig"));const o=t.dist;return yield this.execute(protocol_2.ModuleName.compile,protocol_1.CompileCmdEnum.Compile,{from:this.watch?"watch":"force",type:"mobile",compilePath:this.projectPath,packageType:"PKG",blockTypeId:e}),path_1.default.join(o,e)}))}readProjectConfig(){try{return fs_extra_1.default.readJSONSync(path_1.default.join(this.projectPath,this.projectConfigFileName))}catch(e){return{appid:"",projectname:"unkown"}}}readBlockInfoByPath(e){return fs_extra_1.default.readJSONSync(path_1.default.join(this.projectPath,e+".json"))}readBlockConfig(e,t){if(void 0===t&&(t=this.readProjectConfig()),Array.isArray(t.blocks)){const o=t.blocks.map(e=>{const t=path_1.default.resolve(this.projectPath,e),o=fs_extra_1.default.readJSONSync(t+".json");return[o.blockTypeID,{blockTypeId:o.blockTypeID,blockRenderType:o.blockRenderType,offlineWebConfig:o.offlineWebConfig,blockPath:t,blockOriginPath:e}]}).filter(e=>void 0!==e[0]);if(e){return new Map(o).get(e)}return o.map(e=>e[1])}return e?void 0:[]}returnSuccess(e,t,o){return{code:e,msg:o||"",data:t}}getAppMeta(e){return __awaiter(this,void 0,void 0,(function*(){return(yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getBlockMeta,{lark_version:"",lang:"zh_CN",app_queries:[{extension_queries:[{extension_type:"block",extension_id:e}]}]})).app_metas[0]}))}getBlockMeta(e){return __awaiter(this,void 0,void 0,(function*(){try{const{app_base_info:t}=yield this.getAppMeta(e);return{name:t.name,icon:t.icon}}catch(e){return null}}))}getUserInfo(e,t){return __awaiter(this,void 0,void 0,(function*(){try{const o=new Encrypt_1.default,{session:r}=yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.ttBlockLogin,{appid:t,platform:"pc"},{responseCode:!0}),{encryptedData:i}=yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getOpenUserSummary,{appid:t,platform:"pc",session:r,ttcode:o.getTTCode(),userids:[e]},{responseCode:!0}),a=JSON.parse(o.decrypt(i)).open_user_summary[e],s=a.avatar_urls[0].split("?")[0];return{id:a.id,name:a.name,avatar:s}}catch(e){return null}}))}searchUser(e,t){return __awaiter(this,void 0,void 0,(function*(){try{const{session:o}=yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.ttBlockLogin,{appid:t,platform:"pc"},{responseCode:!0}),{data:r}=yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.searchUser,{appid:t,keyword:e,session:o}),i=JSON.parse(r),a=new Encrypt_1.default,{encryptedData:s}=yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getUserIDByOpenID,{appid:t,platform:"pc",openids:i.map(e=>e.id),session:o,ttcode:a.getTTCode()},{responseCode:!0}),{userids:c}=JSON.parse(a.decrypt(s));return i.map(e=>({id:c[e.id],avatar:e.avatar_url,name:e.name,department:e.department}))}catch(e){return[]}}))}startHTTPServer(e){return __awaiter(this,void 0,void 0,(function*(){if(this.httpServerPort)return Promise.resolve(this.httpServerPort);const t=(0,express_1.default)(),o=yield new Promise(e=>{const o=t.listen(0,"127.0.0.1",()=>e(o.address()))}),r=path_1.default.resolve(__dirname,"..","..","..","pages");return this.ServerSentEvents=new express_sse_1.default,t.use("/*",(0,cors_1.default)({credentials:!0,origin:!0})),t.use("/simulator",(e,t,o)=>__awaiter(this,void 0,void 0,(function*(){if("/block.html"===e.path){const o=this.execute(protocol_2.ModuleName.account,protocol_1.AccountCmdEnum.Info);let i=yield fs_extra_1.default.readFile(path_1.default.join(r,"block.html"),"utf-8"),a="",s="";const{blockTypeID:c,host:n}=e.query;if(o){if(s="window.user = "+JSON.stringify(o.user)+";",s+="window.tenant = "+JSON.stringify(o.tenant)+";","REPLACE_WITH_ACTUAL_BLOCK_TYPE_ID"!==c){const e=yield this.getBlockMeta(c);e&&(s+="window.blockInfo = "+JSON.stringify(e)+";",a=e.name)}s="<script>"+s+"<\/script>"}a||(a="docs"===n?"云文档小组件":"工作台小组件"),i=i.replace("</head><body>","<title>"+a+" - Block 开发者工具</title>"+s+"</head><body>"),t.status(200).send(i)}else express_1.default.static(r)(e,t,o)}))),e&&t.use("/devtools",express_1.default.static(e)),t.get("/events",this.ServerSentEvents.init),t.get("/api/meta",(e,t)=>__awaiter(this,void 0,void 0,(function*(){const{appid:r}=this.readProjectConfig(),{blockTypeIds:i}=e.query;let a=[];if("string"!=typeof i)return void t.json(this.returnSuccess(-1,{},"Invalid query blockTypeIds"));a=i.split(",");const s=this.readBlockConfig(),c=a.map(e=>{const t=s.find(t=>t.blockTypeId===e);return t||{blockOriginPath:"",blockPath:"",blockTypeId:e,blockRenderType:"blockDSL"}});let n={};try{const{app_metas:e}=yield this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.getBlockMeta,{lang:"zh_CN",app_queries:[{extension_queries:{extension_type:"block",extension_id:c[0].blockTypeId}}]}),{app_base_info:t}=e[0];t&&(n=t)}catch(e){}const l=(null==n?void 0:n.app_id)||r;t.json(this.returnSuccess(0,{app_metas:[{app_base_info:{app_id:l,bot_id:(null==n?void 0:n.bot_id)||"",icon:(null==n?void 0:n.icon)||"",name:(null==n?void 0:n.name)||"",openSchemaWhiteList:(null==n?void 0:n.openSchemaWhiteList)||"",useOpenSchemaWhiteList:(null==n?void 0:n.useOpenSchemaWhiteList)||"",version:(null==n?void 0:n.version)||""},extension_metas:c.map(e=>{const t=Upload_1.default.getExtensionSubType(e.blockRenderType),r=[`http://localhost:${o.port}/`];return{app_id:l,basic_lib_version:"",ext_config:JSON.stringify({pkg_type:t,v_host:"",fallback_path_list:r}),extension_id:e.blockTypeId,meta:JSON.stringify({pkg:{[t+"_zip"]:{url:"",md5:"",components:null,backup_urls:[""],lib_version:null,schema_data:null,need_interface:!0,base_path:this.getRelativePath(e),fallback_path_list:r,offline_web_config:e.offlineWebConfig}}}),schema_data:"",update_description:"",update_type:0,version:"99.99.99"}})}]}))}))),t.get("/api/block",(e,t)=>{const o=this.readProjectConfig().appid;t.json(Block.returnSuccess(0,{blocks:this.readBlockConfig().map(e=>({name:{"zh-CN":e.blockTypeId,"en-US":e.blockTypeId,"ja-JP":e.blockTypeId},appID:o,appName:{"zh-CN":"开发者工具","en-US":"DevTools","ja-JP":"開発者ツール"},icon:defaultIcon,filledIcon:defaultIcon,outlinedIcon:defaultIcon,blockTypeID:e.blockTypeId}))}))}),t.get("/api/block/:id/restartCompiler",(e,t)=>{this.ServerSentEvents.serialize([{type:"restartCompiler",data:{blockTypeId:e.params.id}}]),t.status(204).end()}),t.get("/api/user/search",(e,t)=>{const{wd:o}=e.query,{appid:r}=this.readProjectConfig();this.searchUser(o,r).then(e=>{t.json(Block.returnSuccess(0,{list:e}))})}),t.get("/api/user/:id",(e,t)=>{const{id:o}=e.params,{appid:r}=this.readProjectConfig();this.getUserInfo(o,r).then(e=>{t.json(Block.returnSuccess(0,e))})}),t.get("/api/group",(e,t)=>{this.execute(protocol_2.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API.searchGroup,{page:1,page_size:20,keyword:e.query.wd},{responseCode:!0}).then(e=>{0===e.code?t.json(Object.assign(Object.assign({},e),{data:{list:e.data.group_list.map(e=>({id:e.chat_id,name:e.name,avatar:e.avatar_url}))}})):t.json(e)})}),t.get("/api/shell/open/project",(e,t)=>{this.execute(protocol_2.ModuleName.ui,protocol_1.UICmdEnum.openPage,this.projectPath),t.status(204).end()}),t.get("/api/shell/open",(e,t)=>{const{url:o}=e.query;this.execute(protocol_2.ModuleName.ui,protocol_1.UICmdEnum.openPage,o.toString()),t.status(204).end()}),t.get("/static/:type/:id.ttpkg.js",(e,t)=>__awaiter(this,void 0,void 0,(function*(){const{id:o,type:r}=e.params;if((o!==this.currentBlockTypeID||this.useNewCompiler)&&(this.compilePackagePath="",this.currentBlockTypeID=o,this.compileTask=null,this.useNewCompiler=!1),["block","creator"].includes(r)){let e;this.watch&&this.compilePackagePath?e=this.compilePackagePath:(this.compileTask&&this.watch||(this.compileTask=this.compile(o)),timer_1.default.start("block_debug_first_compile"),e=yield this.compileTask.catch(e=>(this.execute(protocol_2.ModuleName.eventTracker,protocol_1.EventTrackerCmdEnum.PerformanceTrack,"block_debug_first_compile",Object.assign(Object.assign({},timer_1.default.end("block_debug_first_compile")),{error:e})),"")),this.watch&&e&&(this.compilePackagePath=e)),e?(t.setHeader("Cache-Control","no-store"),t.download(path_1.default.join(e,`__${r}__`,"app.ttpkg.js"),`${r}-${o}.ttpkg.js`)):t.status(404).end()}else t.status(404).end()}))),this.httpServerPort=o.port,o.port}))}choose(){return __awaiter(this,void 0,void 0,(function*(){const e=this.readBlockConfig().map(e=>e.blockTypeId);if(0===e.length)throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:"Block configuration is incorrect",advise:`Check whether the blocks field in ${this.projectConfigFileName} and the blockTypeID field in block.json are correct`});if(1===e.length)return Promise.resolve(e[0]);return yield this.execute(protocol_2.ModuleName.ui,protocol_1.UICmdEnum.pick,e,"Please choose one block")}))}getAvailableBlockHost(){return[{name:"文档",value:"docs",fgKey:common_1.FeatureGatingKeys.enableBlockDoc},{name:"工作台",value:"workplace",fgKey:common_1.FeatureGatingKeys.enableBlockWorkspace},{name:"搜索",value:"search",fgKey:common_1.FeatureGatingKeys.enableBlockSearch}].filter(e=>(0,common_1.featureGating)(e.fgKey)).map(e=>({name:e.name,value:e.value}))}getRelativePath(e){return e?path_1.default.relative(this.projectPath,path_1.default.dirname(e.blockPath)):""}rewriteProjectConfig(e){const t=this.readProjectConfig(),o=()=>{};if(!Array.isArray(t.blocks))return o;if(t.blocks.length<2)return o;if(!e)return o;const r=path_1.default.join(this.projectPath,this.projectConfigFileName),i=t.blocks;return t.blocks=[e.blockOriginPath],fs_extra_1.default.writeJSONSync(r,t,{spaces:2}),()=>{t.blocks=i,fs_extra_1.default.writeJSONSync(r,t,{spaces:2})}}}exports.default=Block;