"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function c(e){try{a(o.next(e))}catch(e){s(e)}}function i(e){try{a(o.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(c,i)}a((o=o.apply(e,t||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFreePortSync=exports.getRandomPort=exports.getUsedPorts=exports.getFreePort=exports.isPortFree=void 0;const net_1=__importDefault(require("net")),child_process_1=require("child_process"),usedPortsCache=[];function isPortFree(e,t="127.0.0.1"){return new Promise(r=>{const o=new net_1.default.Socket;o.once("error",e=>{e&&"ECONNREFUSED"!==e.code?r(!1):r(!0)}),o.once("connect",()=>{o.destroy(),o.unref(),r(!1)}),o.connect({host:t,port:e})})}function getFreePort(e=8081){return __awaiter(this,void 0,void 0,(function*(){let t=e;for(;;){if(yield isPortFree(t))return t;t++}}))}exports.isPortFree=isPortFree,exports.getFreePort=getFreePort;const getUsedPorts=(e=[])=>{try{const t=new RegExp("\\s(0.0.0.0|127.0.0.1):(\\d+)\\s","g"),r=new RegExp("\\s(\\*|127.0.0.1)\\.(\\d+)\\s","g");let o=":";const n=(0,child_process_1.execSync)("netstat -an",{encoding:"utf-8"});let s=n.match(t);s||(s=n.match(r),o=".");const c=s?s.map(e=>{const t=e.split(o).slice(-1)[0];return parseInt(t.slice(0,-1),10)}):[];return[...new Set(c.concat(e))]}catch(t){return e}};exports.getUsedPorts=getUsedPorts;const getRandomPort=()=>{const e=Math.floor(6e4*Math.random());return e<1e3?(0,exports.getRandomPort)():e};exports.getRandomPort=getRandomPort;const getFreePortSync=()=>{const e=(0,exports.getUsedPorts)(usedPortsCache);for(;;){const t=(0,exports.getRandomPort)();if(!e.includes(t))return usedPortsCache.push(t),t}};exports.getFreePortSync=getFreePortSync;