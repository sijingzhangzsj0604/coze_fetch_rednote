"use strict";var _a,__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.enableWebSecurity=exports.disableHttpProxy=exports.enableStorageV2=exports.enableNewOpenPlatform=exports.clearFG=exports.getCliConfig=exports.getHelpConfig=exports.featureGatingH5Block=exports.featureGatingBlock=exports.featureGating=exports.configManager=exports.ConfigManager=exports.zipFileName=exports.zipSuffix=exports.PKGFileName=exports.PKGFileSuffix=exports.FeatureGatingKeys=void 0;const fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),Logger_1=require("../common/Logger"),port_1=require("../utils/port"),env_1=__importDefault(require("./env"));exports.FeatureGatingKeys={enableGadgetPlugin:"opdev.gadget.enable_gadget_plugin",enableBlock:"opdev.gadget.enable_block",enableBlockDoc:"lark.developer_console.enable_block",enableBlockWorkspace:"lark.developer_console.enable_workspace_block",enableBlockSearch:"lark.developer_console.enable_search_block",enableWebviewSafeDomain:"opdev.gadget.enable_webview_safe_domain",enableBlockH5:"opdev.gadget.enable_block_h5",enableH5BlockSearch:"lark.developer_console.enable_h5_block_in_search",enableH5BlockWorkspace:"lark.developer_console.enable_h5_block_in_workspace",enableNewOpenPlatform:"opdev.block.enable_limit_host",enableStorageV2:"opdev.storage.v2",disableHttpProxy:"opdev.http_proxy.disable",enableWebSecurity:"opdev.simulator.enable_websecurity"},exports.PKGFileSuffix=".ttpkg.js",exports.PKGFileName="app"+exports.PKGFileSuffix,exports.zipSuffix=".zip",exports.zipFileName="__dist__.zip";const port=Number(null===(_a=process.argv.find(e=>e.startsWith("--remote-debugging-port")))||void 0===_a?void 0:_a.split("=")[1]);class ConfigManager{constructor(){this.config={},this.init()}init(){const{version:e,renderType:t,commitHash:a,name:o,oversea:r}=env_1.default,n=isNaN(port)?(0,port_1.getFreePortSync)():port;this.config={CacheRoot:path_1.default.join(os_1.default.homedir(),".mpdev"+(t?"-"+t:"")+(env_1.default.private?"-"+o.toLowerCase():""))+(r?"-lark":""),updateFile:"update.json",fgFile:"fg.json",downloadTemp:".download_temp",staticFile:"static.json",storageFile:"storage.json",storageFileV2:"storage.sec.json",buildFile:"builds",gadgetJSSDKFiles:"gadget-jssdk",userData:"userData",version:e,slardarInitConfig:{bid:"electron_feishu_devtools_cli",isOpen:![process.env.CLI_ENV||"",process.env.ELECTRON_ENV||""].includes("development")&&!env_1.default.private&&!process.env.DISABLE_LOG,commonTags:{renderType:t,cliVersion:e,platform:os_1.default.type(),ideVersion:e,commitHash:a}},feedBackContext:{version:e,commitHash:a},debugPort:n,opdevPacPort:(0,port_1.getFreePortSync)()}}refresh(){this.init()}}let featureGatingData,helpConfigData,cliConfig;exports.ConfigManager=ConfigManager,exports.configManager=new ConfigManager;let useDefaultConfig=!0;const defaultHelpConfigData={docList:{FAQ:{i18nName:{"en-US":"FAQ","zh-CN":"常见问题"},url:"https://open.feishu.cn/document/uYjL24iN/ugDM0YjL4ADN24COwQjN"},Manual:{i18nName:{"en-US":"User Manual","zh-CN":"用户手册"},url:"https://open.feishu.cn/document/uYjL24iN/ucDOzYjL3gzM24yN4MjN"}},feedbackUrl:"",feedbackTip:""},defaultCliCofig={installCmd:"",uninstallCmd:"",needUpdate:!1,forceUpdate:!1,updateReason:"",latestVersion:"",templateMeta:{list:[]}};function readUpdateJSON(){const e=path_1.default.join(exports.configManager.config.CacheRoot,exports.configManager.config.updateFile),t=path_1.default.join(exports.configManager.config.CacheRoot,exports.configManager.config.fgFile);try{if(!fs_extra_1.default.existsSync(e)||!fs_extra_1.default.existsSync(t))throw Error("update.json not exist");{const a=fs_extra_1.default.readJSONSync(e),o=fs_extra_1.default.readJSONSync(t),{data:r={}}=a,{help:n=defaultHelpConfigData,cli:i=defaultCliCofig}=r;featureGatingData=o.data.features.reduce((e,t)=>(e[t]=!0,e),{}),helpConfigData=n,cliConfig=i,useDefaultConfig=!1}(0,Logger_1.logger)().info("readUpdateJSON","checkFile","end",{})}catch(e){(0,Logger_1.logger)().info("readUpdateJSON","checkFile","end",{e:e.toString()}),featureGatingData={},helpConfigData=defaultHelpConfigData,cliConfig=defaultCliCofig}return{featureGatingData:featureGatingData,helpConfigData:helpConfigData,cliConfig:cliConfig}}function featureGating(e){if(useDefaultConfig&&(readUpdateJSON(),(0,Logger_1.logger)().info("readUpdateJSON","update fg","end",{})),Array.isArray(e)){const t={};return e.forEach(e=>{t[e]=featureGatingData[e]||!1}),t}return void 0===e?featureGatingData:featureGatingData[e]||!1}function featureGatingBlock(){const e=featureGating([exports.FeatureGatingKeys.enableBlockDoc,exports.FeatureGatingKeys.enableBlockWorkspace,exports.FeatureGatingKeys.enableBlockSearch]);return e[exports.FeatureGatingKeys.enableBlockDoc]||e[exports.FeatureGatingKeys.enableBlockWorkspace]||e[exports.FeatureGatingKeys.enableBlockSearch]}function featureGatingH5Block(){const e=featureGating([exports.FeatureGatingKeys.enableH5BlockWorkspace,exports.FeatureGatingKeys.enableH5BlockSearch,exports.FeatureGatingKeys.enableBlockH5]);return e[exports.FeatureGatingKeys.enableBlockH5]&&(e[exports.FeatureGatingKeys.enableH5BlockWorkspace]||e[exports.FeatureGatingKeys.enableH5BlockSearch])}function getHelpConfig(){if(useDefaultConfig){const{helpConfigData:e}=readUpdateJSON();return e}return helpConfigData}function getCliConfig(){const{cliConfig:e}=readUpdateJSON();return e}function clearFG(){useDefaultConfig=!0}exports.featureGating=featureGating,exports.featureGatingBlock=featureGatingBlock,exports.featureGatingH5Block=featureGatingH5Block,exports.getHelpConfig=getHelpConfig,exports.getCliConfig=getCliConfig,exports.clearFG=clearFG;const enableNewOpenPlatform=()=>featureGating([exports.FeatureGatingKeys.enableNewOpenPlatform])[exports.FeatureGatingKeys.enableNewOpenPlatform];exports.enableNewOpenPlatform=enableNewOpenPlatform;const enableStorageV2=()=>featureGating([exports.FeatureGatingKeys.enableStorageV2])[exports.FeatureGatingKeys.enableStorageV2];exports.enableStorageV2=enableStorageV2;const disableHttpProxy=()=>featureGating([exports.FeatureGatingKeys.disableHttpProxy])[exports.FeatureGatingKeys.disableHttpProxy];exports.disableHttpProxy=disableHttpProxy;const enableWebSecurity=()=>featureGating([exports.FeatureGatingKeys.enableWebSecurity])[exports.FeatureGatingKeys.enableWebSecurity];exports.enableWebSecurity=enableWebSecurity;