"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,o,r,t){void 0===t&&(t=r);var a=Object.getOwnPropertyDescriptor(o,r);a&&!("get"in a?!o.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return o[r]}}),Object.defineProperty(e,t,a)}:function(e,o,r,t){void 0===t&&(t=r),e[t]=o[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(o,e,r);return __setModuleDefault(o,e),o},__awaiter=this&&this.__awaiter||function(e,o,r,t){return new(r||(r=Promise))((function(a,n){function i(e){try{s(t.next(e))}catch(e){n(e)}}function l(e){try{s(t.throw(e))}catch(e){n(e)}}function s(e){var o;e.done?a(e.value):(o=e.value,o instanceof r?o:new r((function(e){e(o)}))).then(i,l)}s((t=t.apply(e,o||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const archiver_1=__importDefault(require("archiver")),fs_extra_1=__importDefault(require("fs-extra")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),uuid_1=require("uuid"),node_1=__importDefault(require("@lark-opdev/i18n/libs/node")),Error_1=__importStar(require("../../../common/Error")),Logger_1=__importDefault(require("../../../common/Logger")),common_error_1=require("../../../common/common-error"),compile_error_1=require("../../../common/compile-error"),request_error_1=require("../../../common/request-error"),api_1=require("../../../config/api"),common_1=require("../../../config/common"),lark_1=__importDefault(require("../../../config/lark")),protocol_1=require("../../../protocol"),upload_1=require("../../../types/upload"),utils_1=require("../../../utils/utils"),Middleware_1=require("../../service/help/Middleware");var CompileProgressStatus;!function(e){e[e.fail=0]="fail",e[e.pending=1]="pending",e[e.done=2]="done",e[e.nonFound=3]="nonFound"}(CompileProgressStatus||(CompileProgressStatus={}));class Upload{static checkLogin(e){if(!e(protocol_1.ModuleName.account,protocol_1.AccountCmdEnum.IsLogin))throw new Error_1.default({code:Error_1.CoreErrorCode.NOT_LOGIN,message:node_1.default.t("NOT_LOGIN")})}static checkAppId(e,o){if(!lark_1.default.appIdRule.test(e))throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:node_1.default.t("PARAM_ERROR_APPID_INVALID")})}static prepareCheck(e,o,r){return __awaiter(this,void 0,void 0,(function*(){if(!(0,utils_1.checkCompilePath)(e))throw new Error_1.default({code:Error_1.CoreErrorCode.COMPILE_PATH_ERROR,message:node_1.default.t("COMPILE_PATH_ERROR_PATH_INVALID")});try{Upload.checkLogin(r);const{appId:t,projectConfig:a}=yield Upload.readProjectConfig(e);return o=o||t,yield Upload.checkAppId(o,r),{appId:o,compilePath:e,projectConfig:a}}catch(e){throw new common_error_1.CommonError(Error_1.CoreErrorCode.USER_ERROR,2100000001,e.message,e.stack)}}))}static readProjectConfig(e){return __awaiter(this,void 0,void 0,(function*(){const o=yield(0,utils_1.readFileContent)(e,"project.config.json");return{appId:o.appid,projectName:o.projectname,projectConfig:o}}))}static choosePlatform(e,o){const r=Object.entries(upload_1.GadgetPlatform),t=r.map(e=>e[1]);if(e){if(t.includes(e))return Promise.resolve(e);throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:node_1.default.t("PARAM_ERROR_PLATFORM",{platformIds:t.join(", ")})})}return o(protocol_1.ModuleName.ui,protocol_1.UICmdEnum.pick,r.map(([e,o])=>({name:e,value:o})),"Please choose platform")}static getGlobs(e){if("gadget"===e.appType){const o=path_1.default.join(e.compilePath,"project.config.json");if(fs_extra_1.default.existsSync(o)){const r=fs_extra_1.default.readJSONSync(o),{miniprogramRoot:t,pluginRoot:a}=r;return"plugin"===e.compileType?[a.replace(/^[./]*/,"").replace(/\/?$/,"/**/*"),"project.config.json"]:t&&""!==t.replace(/^[./]*/,"")?[t.replace(/^[./]*/,"").replace(/\/?$/,"/**/*"),"project.config.json"]:["**/*"]}}return["**/*"]}static checkPackageSize(e,o,r={},t,a){var n;return __awaiter(this,void 0,void 0,(function*(){const{maxSize:i=upload_1.MAX_PACKAGE_SIZE,maxUseSubPackagesSize:l=upload_1.MAX_USE_SUB_PACKAGE_SIZE,maxSubPackageSize:s=upload_1.MAX_SUB_PACKAGE_SIZE}=r;if(fs_extra_1.default.statSync(o).size>62914560)return node_1.default.t("PARAM_ERROR_PKG_EXCEED_LIMIT",{MAX_PKG_SIZE:i/1024/1024});const d=yield Upload.getZipSizeNotMap(e,t,a),_=Upload.getAppJson(e),c=(null==_?void 0:_.subpackages)||(null==_?void 0:_.subPackages);if(Array.isArray(c)&&c.length>0){if(d>l)return node_1.default.t("PARAM_ERROR_MAIN_PKG_EXCEED_LIMIT",{MAX_PKG_SIZE:l/1024/1024});const o=[];let r=0;for(const t of c)if(t.root){const a=yield Upload.getZipSizeNotMap(path_1.default.join(e,t.root));r+=a,a>s&&o.push(null!==(n=t.name)&&void 0!==n?n:t.root)}if(d>r+s)return o.length>0?node_1.default.t("PARAM_ERROR_MAIN_SUB_PKG_EXCEED_LIMIT",{SUB_PKG_NAME:o.join(","),MAX_PKG_SIZE:s/1024/1024}):node_1.default.t("PARAM_ERROR_MAIN_PKG_EXCEED_LIMIT",{MAX_PKG_SIZE:s/1024/1024});if(o.length>0)return node_1.default.t("PARAM_ERROR_SUB_PKG_EXCEED_LIMIT",{SUB_PKG_NAME:o.join(","),MAX_PKG_SIZE:s/1024/1024})}else if(d>i)return node_1.default.t("PARAM_ERROR_PKG_EXCEED_LIMIT",{MAX_PKG_SIZE:i/1024/1024})}))}static getZipSizeNotMap(e,o=["**/*"],r=[]){return __awaiter(this,void 0,void 0,(function*(){const t=yield Upload.zip({cwd:e,globs:o,ignore:r.concat(["**/*.map"])});return fs_extra_1.default.statSync(t).size}))}static compress(e,o){var r;return __awaiter(this,void 0,void 0,(function*(){const t=(new Date).valueOf(),a=os_1.default.tmpdir()+path_1.default.sep+e.appId+e.platform+e.version+t+".zip";Array.isArray(e.globs)||(e.globs=Upload.getGlobs(e));const n=((e.useNPM||o&&(null===(r=o(protocol_1.ModuleName.storage,protocol_1.StorageCmdEnum.Get,e.compilePath,"simulatorConfig"))||void 0===r?void 0:r.useNPM))&&"gadget"===e.appType?[".*/**/*"]:[".*/**/*","node_modules/**/*"]).concat(e.ignore||[]);yield Upload.zip({cwd:e.compilePath,globs:e.globs,ignore:n,outputPath:a});const i=yield Upload.checkPackageSize(e.compilePath,a,{maxSize:e.maxPkgSize},e.globs,n);if(i)throw new Error_1.default({code:Error_1.CoreErrorCode.PARAM_ERROR,message:i,advise:a});return a}))}static zip(e){return __awaiter(this,void 0,void 0,(function*(){const{cwd:o,globs:r=["**/*"],ignore:t=[".*/**/*"],outputPath:a=path_1.default.join(os_1.default.tmpdir(),(0,uuid_1.v1)()+".zip")}=e;return yield new Promise((e,n)=>{const i=fs_extra_1.default.createWriteStream(a),l=(0,archiver_1.default)("zip");l.on("error",e=>{n(e)}),l.pipe(i),r.forEach(e=>{l.glob(e,{cwd:o,ignore:t})}),l.finalize(),i.on("close",()=>{e(a)})}),a}))}static checkCompileProgress(e,o,r,t,a,n){const{environment:i}=r(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.GetEnvironment),l=new Logger_1.default("Upload"),s=l.info.bind(l,"checkCompileProgress"),d=Upload.getExtensionTypeByAppType(t,a);s("receiveParams","end",{appId:e,extensionType:d});const _=(0,common_1.featureGating)("opdev.compile.progress"),c=_?"compileProgress":o;return new Promise((t,a)=>{let l=0;const s=setInterval(()=>{if(++l,l>upload_1.MAX_POLLING_RETRY_COUNT)return clearInterval(s),void a(new common_error_1.CommonError(Error_1.CoreErrorCode.CORE_MODULE_ERROR,2300000004,node_1.default.t("COMPILE_TIMEOUT"),void 0,node_1.default.t("COMPILE_TIMEOUT_ADVISE")));r(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API[c],Object.assign({appId:e},_?{extension_type:d}:{package_type:"gadgetPluginCompileProgress"===o?"gadget_plugin":""}),{timeout:5e4,responseCode:!0,logId:!0,traceId:n,retries:5}).then(e=>{var o,r,n,l,d;const _=e.message||(null===(r=null===(o=e.error)||void 0===o?void 0:o.localizedMessage)||void 0===r?void 0:r.message)||(null===(n=e.error)||void 0===n?void 0:n.msg)||e.msg,c=null!==(l=e.error)&&void 0!==l?l:e.code,u=null!==(d=e.status)&&void 0!==d?d:e.data.compile_status;e.code===Middleware_1.ServerResponseCode.COMPILE_ERROR||(null==_?void 0:_.startsWith("compile fail"))?(clearInterval(s),a(new compile_error_1.CompileError(_,e.logId,i))):0!==c?(clearInterval(s),a(new request_error_1.RequestError(node_1.default.t("REQUEST_CHECK_COMPILE_PROGRESS_FAIL",{errStr:_}),e.code,e.logId,e.stable))):u===CompileProgressStatus.done?(t(),clearInterval(s)):u===CompileProgressStatus.nonFound&&(a(new request_error_1.RequestError("Compile Task Not Found",e.code,e.logId,e.stable)),clearInterval(s))},a)},2e3)})}static getQRCodeUrl(e,o,r,t,a){return a(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,api_1.API[t],{appId:e,version:o,start_page:r}).then(e=>{if("getPCGadgetQRCode"===t){const o=new URL(e.url),r=o.searchParams,t={previewToken:r.get("token")||""};return r.set("url",JSON.stringify(t)),r.delete("token"),o.toString()}return e.url})}static isPCPlatform(e){return e===upload_1.GadgetPlatform.PC}static upload(e,o,r,t,a){const n=api_1.API[e];return r.appId=o,a(protocol_1.ModuleName.service,protocol_1.ServiceCmdEnum.Request,n,r,{headers:t.headers,responseCode:!0,traceId:t.traceId,logId:!0})}static checkUploadResponds(e){const{error:o,code:r,message:t,msg:a,data:n,logId:i,stable:l}=e;"development"!==process.env.CLI_ENV&&"development"!==process.env.ELECTRON_ENV||console.log("ðŸš€ ~ file: Upload.ts ~ line 355 ~ Upload ~ checkUploadResponds ~ uploadResponse",{data:n,message:t,logId:i});const s="number"==typeof o?o:r;if(0!==s){let e=node_1.default.t("REQUEST_UPLOAD_FAIL",{errStr:t||a||""});throw 109===r&&(e=r.toString()),new request_error_1.RequestError(e,s,i,l)}}static versionIncrement(e,o){if(!this.versionRule.test(e))return"1.0.0";const r=e.split(".").map(e=>parseInt(e));switch(o){case upload_1.VersionIncrement.major:r[0]+=1,r[1]=0,r[2]=0;break;case upload_1.VersionIncrement.minor:r[1]+=1,r[2]=0;break;case upload_1.VersionIncrement.patch:r[2]+=1}return r.join(".")}static getMobileGadgetMode(e){try{const o=Upload.getAppJson(e);if(!o||!o.ext||!o.ext.defaultPages)return 0;let r=0;return o.ext.defaultPages.sidebarMode&&(r+=1),o.ext.defaultPages.PCMode&&(r+=2),r}catch(e){return 0}}static getExtensionSubType(e){return{offlineWeb:"block_h5",blockDSL:"block_dsl"}[e||"blockDSL"]}static getAppJson(e){const o=path_1.default.join(e,"project.config.json");if(!fs_extra_1.default.existsSync(o))return null;const{miniprogramRoot:r="."}=fs_extra_1.default.readJSONSync(o),t=path_1.default.join(e,r,"app.json");return fs_extra_1.default.existsSync(t)?fs_extra_1.default.readJSONSync(t):null}static getExtensionTypeByAppType(e,o){switch(e){case"block":return"gadget_block";case"h5_offline":return"web_offline";case"h5_in_block":return"gadget_h5";case"gadget":if(o===upload_1.GadgetPlatform.PC)return"gadget_pc";if(o===upload_1.GadgetPlatform.Mobile)return"gadget_mobile";throw new Error(`not found extensionType by gadget platform ${o}, only support pc or mobile`);case"gadget_plugin":return"gadget_plugin";default:throw new Error("not found extensionType by appType "+e)}}}Upload.versionRule=/^\d+\.\d+\.\d+$/,exports.default=Upload;